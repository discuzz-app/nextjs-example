"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(t,e,n){n.d(e,{u7:function(){return yu},Jj:function(){return fc},IX:function(){return Wa},hx:function(){return qa},my:function(){return Oa},xU:function(){return zc},Lz:function(){return lc},GH:function(){return mc},gg:function(){return Ha},WA:function(){return S},F8:function(){return gc},tO:function(){return Qa},AE:function(){return Va},O$:function(){return Xc},$q:function(){return Qc},W:function(){return Wc},oZ:function(){return Gc},EK:function(){return B},YW:function(){return Ou},PU:function(){return Iu},l7:function(){return _a},Ky:function(){return ut},Mu:function(){return F},EZ:function(){return A},Xb:function(){return H},Cf:function(){return Ra},K9:function(){return T},Me:function(){return J},yq:function(){return y},Wi:function(){return Na},ET:function(){return Ru},Ab:function(){return Ku},vr:function(){return Bu},Fc:function(){return rc},hJ:function(){return Ua},B$:function(){return Ba},at:function(){return Pa},oe:function(){return xu},AK:function(){return qu},TF:function(){return oc},JU:function(){return Ka},Jm:function(){return dc},ST:function(){return tc},fH:function(){return ec},Ix:function(){return ic},Wu:function(){return du},Lx:function(){return lu},qY:function(){return Xa},GL:function(){return Mu},QT:function(){return Eu},kl:function(){return Su},Xk:function(){return _u},PL:function(){return ku},UQ:function(){return Au},zN:function(){return Nu},ad:function(){return Ja},nP:function(){return $u},LV:function(){return Ya},b9:function(){return iu},vh:function(){return ou},Pb:function(){return cc},L$:function(){return uc},cf:function(){return Lu},sc:function(){return Fu},Xo:function(){return ru},IO:function(){return Zc},iE:function(){return ja},Eo:function(){return $a},i3:function(){return Vu},Bt:function(){return Uu},pl:function(){return Du},Ub:function(){return m},qK:function(){return Yc},TQ:function(){return uu},e0:function(){return cu},RA:function(){return ac},r7:function(){return Cu},Mx:function(){return sc},ar:function(){return eu},qs:function(){return ju}});var r=n(2238),s=n(8463),i=n(3333),o=n(4444),a=n(3510),c=n(4155);const u="@firebase/firestore";class h{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}h.UNAUTHENTICATED=new h(null),h.GOOGLE_CREDENTIALS=new h("google-credentials-uid"),h.FIRST_PARTY=new h("first-party-uid"),h.MOCK_USER=new h("mock-user");let l="9.6.2";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(t){d.setLogLevel(t)}function g(t,...e){if(d.logLevel<=i.in.DEBUG){const n=e.map(w);d.debug(`Firestore (${l}): ${t}`,...n)}}function p(t,...e){if(d.logLevel<=i.in.ERROR){const n=e.map(w);d.error(`Firestore (${l}): ${t}`,...n)}}function y(t,...e){if(d.logLevel<=i.in.WARN){const n=e.map(w);d.warn(`Firestore (${l}): ${t}`,...n)}}function w(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function v(t="Unexpected state"){const e=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+t;throw p(e),new Error(e)}function I(t,e){t||v()}function T(t,e){t||v()}function E(t,e){return t}const b={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class _{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class k{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class A{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(h.UNAUTHENTICATED)))}shutdown(){}}class N{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class D{constructor(t){this.t=t,this.currentUser=h.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new _;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new _,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new _)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(I("string"==typeof e.accessToken),new k(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return I(null===t||"string"==typeof t),new h(t)}}class C{constructor(t,e,n){this.type="FirstParty",this.user=h.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);const r=t.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class x{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new C(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(h.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class R{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null}start(t,e){this.o=n=>{t.enqueueRetryable((()=>(t=>(null!=t.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`),e(t.token)))(n)))};const n=t=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit((t=>n(t))),setTimeout((()=>{if(!this.appCheck){const t=this.g.getImmediate({optional:!0});t?n(t):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(I("string"==typeof t.token),new R(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class F{getToken(){return Promise.resolve(new R(""))}invalidateToken(){}start(t,e){}shutdown(){}}class M{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.p(t),this.T=t=>e.writeSequenceNumber(t))}p(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.T&&this.T(t),t}}function P(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let r=0;r<t;r++)n[r]=Math.floor(256*Math.random());return n}M.I=-1;class O{static A(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const r=P(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<e&&(n+=t.charAt(r[s]%t.length))}return n}}function V(t,e){return t<e?-1:t>e?1:0}function q(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function U(t){return t+"\0"}class B{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return B.fromMillis(Date.now())}static fromDate(t){return B.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new B(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?V(this.nanoseconds,t.nanoseconds):V(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class K{constructor(t){this.timestamp=t}static fromTimestamp(t){return new K(t)}static min(){return new K(new B(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function $(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function j(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function G(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class z{constructor(t,e,n){void 0===e?e=0:e>t.length&&v(),void 0===n?n=t.length-e:n>t.length-e&&v(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===z.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof z?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class Q extends z{construct(t,e,n){return new Q(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new Q(e)}static emptyPath(){return new Q([])}}const W=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class H extends z{construct(t,e,n){return new H(t,e,n)}static isValidIdentifier(t){return W.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),H.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new H(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(b.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new S(b.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new S(b.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new S(b.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new H(e)}static emptyPath(){return new H([])}}class Y{constructor(t){this.fields=t,t.sort(H.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return q(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function J(){return"undefined"!=typeof atob}class X{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new X(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new X(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return V(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}X.EMPTY_BYTE_STRING=new X("");const Z=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tt(t){if(I(!!t),"string"==typeof t){let e=0;const n=Z.exec(t);if(I(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:et(t.seconds),nanos:et(t.nanos)}}function et(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function nt(t){return"string"==typeof t?X.fromBase64String(t):X.fromUint8Array(t)}function rt(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function st(t){const e=t.mapValue.fields.__previous_value__;return rt(e)?st(e):e}function it(t){const e=tt(t.mapValue.fields.__local_write_time__.timestampValue);return new B(e.seconds,e.nanos)}function ot(t){return null==t}function at(t){return 0===t&&1/t==-1/0}function ct(t){return"number"==typeof t&&Number.isInteger(t)&&!at(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class ut{constructor(t){this.path=t}static fromPath(t){return new ut(Q.fromString(t))}static fromName(t){return new ut(Q.fromString(t).popFirst(5))}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===Q.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return Q.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new ut(new Q(t.slice()))}}function ht(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?rt(t)?4:10:v()}function lt(t,e){if(t===e)return!0;const n=ht(t);if(n!==ht(e))return!1;switch(n){case 0:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return it(t).isEqual(it(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=tt(t.timestampValue),r=tt(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return nt(t.bytesValue).isEqual(nt(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return et(t.geoPointValue.latitude)===et(e.geoPointValue.latitude)&&et(t.geoPointValue.longitude)===et(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return et(t.integerValue)===et(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=et(t.doubleValue),r=et(e.doubleValue);return n===r?at(n)===at(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return q(t.arrayValue.values||[],e.arrayValue.values||[],lt);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if($(n)!==$(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!lt(n[s],r[s])))return!1;return!0}(t,e);default:return v()}}function dt(t,e){return void 0!==(t.values||[]).find((t=>lt(t,e)))}function ft(t,e){if(t===e)return 0;const n=ht(t),r=ht(e);if(n!==r)return V(n,r);switch(n){case 0:return 0;case 1:return V(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=et(t.integerValue||t.doubleValue),r=et(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return mt(t.timestampValue,e.timestampValue);case 4:return mt(it(t),it(e));case 5:return V(t.stringValue,e.stringValue);case 6:return function(t,e){const n=nt(t),r=nt(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=V(n[s],r[s]);if(0!==t)return t}return V(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=V(et(t.latitude),et(e.latitude));return 0!==n?n:V(et(t.longitude),et(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=ft(n[s],r[s]);if(t)return t}return V(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=V(r[o],i[o]);if(0!==t)return t;const e=ft(n[r[o]],s[i[o]]);if(0!==e)return e}return V(r.length,i.length)}(t.mapValue,e.mapValue);default:throw v()}}function mt(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return V(t,e);const n=tt(t),r=tt(e),s=V(n.seconds,r.seconds);return 0!==s?s:V(n.nanos,r.nanos)}function gt(t){return pt(t)}function pt(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=tt(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?nt(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,ut.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=pt(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${pt(t.fields[s])}`;return n+"}"}(t.mapValue):v();var e,n}function yt(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function wt(t){return!!t&&"integerValue"in t}function vt(t){return!!t&&"arrayValue"in t}function It(t){return!!t&&"nullValue"in t}function Tt(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Et(t){return!!t&&"mapValue"in t}function bt(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return j(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=bt(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=bt(t.arrayValue.values[n]);return e}return Object.assign({},t)}class St{constructor(t){this.value=t}static empty(){return new St({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Et(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=bt(e)}setAll(t){let e=H.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=bt(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());Et(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return lt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];Et(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){j(e,((e,n)=>t[e]=n));for(const r of n)delete t[r]}clone(){return new St(bt(this.value))}}function _t(t){const e=[];return j(t.fields,((t,n)=>{const r=new H([t]);if(Et(n)){const t=_t(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new Y(e)}class kt{constructor(t,e,n,r,s){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(t){return new kt(t,0,K.min(),St.empty(),0)}static newFoundDocument(t,e,n){return new kt(t,1,e,n,0)}static newNoDocument(t,e){return new kt(t,2,e,St.empty(),0)}static newUnknownDocument(t,e){return new kt(t,3,e,St.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=St.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=St.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof kt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new kt(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class At{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.R=null}}function Nt(t,e=null,n=[],r=[],s=null,i=null,o=null){return new At(t,e,n,r,s,i,o)}function Dt(t){const e=E(t);if(null===e.R){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>function(t){return t.field.canonicalString()+t.op.toString()+gt(t.value)}(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),ot(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=Kt(e.startAt)),e.endAt&&(t+="|ub:",t+=Kt(e.endAt)),e.R=t}return e.R}function Ct(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let s=0;s<t.orderBy.length;s++)if(!jt(t.orderBy[s],e.orderBy[s]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let s=0;s<t.filters.length;s++)if(n=t.filters[s],r=e.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!lt(n.value,r.value))return!1;var n,r;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!zt(t.startAt,e.startAt)&&zt(t.endAt,e.endAt)}function xt(t){return ut.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class Rt extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.P(t,e,n):new Lt(t,e,n):"array-contains"===e?new Ot(t,n):"in"===e?new Vt(t,n):"not-in"===e?new qt(t,n):"array-contains-any"===e?new Ut(t,n):new Rt(t,e,n)}static P(t,e,n){return"in"===e?new Ft(t,n):new Mt(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.v(ft(e,this.value)):null!==e&&ht(this.value)===ht(e)&&this.v(ft(e,this.value))}v(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return v()}}V(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Lt extends Rt{constructor(t,e,n){super(t,e,n),this.key=ut.fromName(n.referenceValue)}matches(t){const e=ut.comparator(t.key,this.key);return this.v(e)}}class Ft extends Rt{constructor(t,e){super(t,"in",e),this.keys=Pt("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Mt extends Rt{constructor(t,e){super(t,"not-in",e),this.keys=Pt("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Pt(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>ut.fromName(t.referenceValue)))}class Ot extends Rt{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return vt(e)&&dt(e.arrayValue,this.value)}}class Vt extends Rt{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&dt(this.value.arrayValue,e)}}class qt extends Rt{constructor(t,e){super(t,"not-in",e)}matches(t){if(dt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!dt(this.value.arrayValue,e)}}class Ut extends Rt{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!vt(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>dt(this.value.arrayValue,t)))}}class Bt{constructor(t,e){this.position=t,this.before=e}}function Kt(t){return`${t.before?"b":"a"}:${t.position.map((t=>gt(t))).join(",")}`}class $t{constructor(t,e="asc"){this.field=t,this.dir=e}}function jt(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function Gt(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?ut.comparator(ut.fromName(o.referenceValue),n.key):ft(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return t.before?r<=0:r<0}function zt(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!lt(t.position[n],e.position[n]))return!1;return!0}class Qt{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.S=null,this.D=null,this.startAt,this.endAt}}function Wt(t,e,n,r,s,i,o,a){return new Qt(t,e,n,r,s,i,o,a)}function Ht(t){return new Qt(t)}function Yt(t){return!ot(t.limit)&&"F"===t.limitType}function Jt(t){return!ot(t.limit)&&"L"===t.limitType}function Xt(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Zt(t){for(const e of t.filters)if(e.V())return e.field;return null}function te(t){return null!==t.collectionGroup}function ee(t){const e=E(t);if(null===e.S){e.S=[];const t=Zt(e),n=Xt(e);if(null!==t&&null===n)t.isKeyField()||e.S.push(new $t(t)),e.S.push(new $t(H.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.S.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.S.push(new $t(H.keyField(),t))}}}return e.S}function ne(t){const e=E(t);if(!e.D)if("F"===e.limitType)e.D=Nt(e.path,e.collectionGroup,ee(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const s of ee(e)){const e="desc"===s.dir?"asc":"desc";t.push(new $t(s.field,e))}const n=e.endAt?new Bt(e.endAt.position,!e.endAt.before):null,r=e.startAt?new Bt(e.startAt.position,!e.startAt.before):null;e.D=Nt(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}return e.D}function re(t,e,n){return new Qt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function se(t,e){return Ct(ne(t),ne(e))&&t.limitType===e.limitType}function ie(t){return`${Dt(ne(t))}|lt:${t.limitType}`}function oe(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${gt(e.value)}`;var e})).join(", ")}]`),ot(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: "+Kt(t.startAt)),t.endAt&&(e+=", endAt: "+Kt(t.endAt)),`Target(${e})`}(ne(t))}; limitType=${t.limitType})`}function ae(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):ut.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!Gt(t.startAt,ee(t),e))&&(!t.endAt||!Gt(t.endAt,ee(t),e))}(t,e)}function ce(t){return(e,n)=>{let r=!1;for(const s of ee(t)){const t=ue(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function ue(t,e,n){const r=t.field.isKeyField()?ut.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?ft(r,s):v()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}function he(t,e){if(t.C){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:at(e)?"-0":e}}function le(t){return{integerValue:""+t}}function de(t,e){return ct(e)?le(e):he(t,e)}class fe{constructor(){this._=void 0}}function me(t,e,n){return t instanceof ye?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof we?ve(t,e):t instanceof Ie?Te(t,e):function(t,e){const n=pe(t,e),r=be(n)+be(t.N);return wt(n)&&wt(t.N)?le(r):he(t.k,r)}(t,e)}function ge(t,e,n){return t instanceof we?ve(t,e):t instanceof Ie?Te(t,e):n}function pe(t,e){return t instanceof Ee?wt(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class ye extends fe{}class we extends fe{constructor(t){super(),this.elements=t}}function ve(t,e){const n=Se(e);for(const r of t.elements)n.some((t=>lt(t,r)))||n.push(r);return{arrayValue:{values:n}}}class Ie extends fe{constructor(t){super(),this.elements=t}}function Te(t,e){let n=Se(e);for(const r of t.elements)n=n.filter((t=>!lt(t,r)));return{arrayValue:{values:n}}}class Ee extends fe{constructor(t,e){super(),this.k=t,this.N=e}}function be(t){return et(t.integerValue||t.doubleValue)}function Se(t){return vt(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class _e{constructor(t,e){this.field=t,this.transform=e}}class ke{constructor(t,e){this.version=t,this.transformResults=e}}class Ae{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Ae}static exists(t){return new Ae(void 0,t)}static updateTime(t){return new Ae(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Ne(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class De{}function Ce(t,e,n){t instanceof Me?function(t,e,n){const r=t.value.clone(),s=Ve(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Pe?function(t,e,n){if(!Ne(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=Ve(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Oe(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function xe(t,e,n){t instanceof Me?function(t,e,n){if(!Ne(t.precondition,e))return;const r=t.value.clone(),s=qe(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(Fe(e),r).setHasLocalMutations()}(t,e,n):t instanceof Pe?function(t,e,n){if(!Ne(t.precondition,e))return;const r=qe(t.fieldTransforms,n,e),s=e.data;s.setAll(Oe(t)),s.setAll(r),e.convertToFoundDocument(Fe(e),s).setHasLocalMutations()}(t,e,n):function(t,e){Ne(t.precondition,e)&&e.convertToNoDocument(K.min())}(t,e)}function Re(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=pe(r.transform,t||null);null!=s&&(null==n&&(n=St.empty()),n.set(r.field,s))}return n||null}function Le(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&q(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof we&&e instanceof we||t instanceof Ie&&e instanceof Ie?q(t.elements,e.elements,lt):t instanceof Ee&&e instanceof Ee?lt(t.N,e.N):t instanceof ye&&e instanceof ye}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function Fe(t){return t.isFoundDocument()?t.version:K.min()}class Me extends De{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Pe extends De{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Oe(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function Ve(t,e,n){const r=new Map;I(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,ge(o,a,n[s]))}return r}function qe(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,me(t,i,e))}return r}class Ue extends De{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class Be extends De{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class Ke{constructor(t){this.count=t}}var $e,je;function Ge(t){switch(t){default:return v();case b.CANCELLED:case b.UNKNOWN:case b.DEADLINE_EXCEEDED:case b.RESOURCE_EXHAUSTED:case b.INTERNAL:case b.UNAVAILABLE:case b.UNAUTHENTICATED:return!1;case b.INVALID_ARGUMENT:case b.NOT_FOUND:case b.ALREADY_EXISTS:case b.PERMISSION_DENIED:case b.FAILED_PRECONDITION:case b.ABORTED:case b.OUT_OF_RANGE:case b.UNIMPLEMENTED:case b.DATA_LOSS:return!0}}function ze(t){if(void 0===t)return p("GRPC error has no .code"),b.UNKNOWN;switch(t){case $e.OK:return b.OK;case $e.CANCELLED:return b.CANCELLED;case $e.UNKNOWN:return b.UNKNOWN;case $e.DEADLINE_EXCEEDED:return b.DEADLINE_EXCEEDED;case $e.RESOURCE_EXHAUSTED:return b.RESOURCE_EXHAUSTED;case $e.INTERNAL:return b.INTERNAL;case $e.UNAVAILABLE:return b.UNAVAILABLE;case $e.UNAUTHENTICATED:return b.UNAUTHENTICATED;case $e.INVALID_ARGUMENT:return b.INVALID_ARGUMENT;case $e.NOT_FOUND:return b.NOT_FOUND;case $e.ALREADY_EXISTS:return b.ALREADY_EXISTS;case $e.PERMISSION_DENIED:return b.PERMISSION_DENIED;case $e.FAILED_PRECONDITION:return b.FAILED_PRECONDITION;case $e.ABORTED:return b.ABORTED;case $e.OUT_OF_RANGE:return b.OUT_OF_RANGE;case $e.UNIMPLEMENTED:return b.UNIMPLEMENTED;case $e.DATA_LOSS:return b.DATA_LOSS;default:return v()}}(je=$e||($e={}))[je.OK=0]="OK",je[je.CANCELLED=1]="CANCELLED",je[je.UNKNOWN=2]="UNKNOWN",je[je.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",je[je.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",je[je.NOT_FOUND=5]="NOT_FOUND",je[je.ALREADY_EXISTS=6]="ALREADY_EXISTS",je[je.PERMISSION_DENIED=7]="PERMISSION_DENIED",je[je.UNAUTHENTICATED=16]="UNAUTHENTICATED",je[je.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",je[je.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",je[je.ABORTED=10]="ABORTED",je[je.OUT_OF_RANGE=11]="OUT_OF_RANGE",je[je.UNIMPLEMENTED=12]="UNIMPLEMENTED",je[je.INTERNAL=13]="INTERNAL",je[je.UNAVAILABLE=14]="UNAVAILABLE",je[je.DATA_LOSS=15]="DATA_LOSS";class Qe{constructor(t,e){this.comparator=t,this.root=e||He.EMPTY}insert(t,e){return new Qe(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,He.BLACK,null,null))}remove(t){return new Qe(this.comparator,this.root.remove(t,this.comparator).copy(null,null,He.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new We(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new We(this.root,t,this.comparator,!1)}getReverseIterator(){return new We(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new We(this.root,t,this.comparator,!0)}}class We{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class He{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:He.RED,this.left=null!=r?r:He.EMPTY,this.right=null!=s?s:He.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new He(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return He.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return He.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,He.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,He.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const t=this.left.check();if(t!==this.right.check())throw v();return t+(this.isRed()?0:1)}}He.EMPTY=null,He.RED=!0,He.BLACK=!1,He.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(t,e,n,r,s){return this}insert(t,e,n){return new He(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Ye{constructor(t){this.comparator=t,this.data=new Qe(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Je(this.data.getIterator())}getIteratorFrom(t){return new Je(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Ye))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Ye(this.comparator);return e.data=t,e}}class Je{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const Xe=new Qe(ut.comparator);function Ze(){return Xe}const tn=new Qe(ut.comparator);function en(){return tn}const nn=new Qe(ut.comparator);function rn(){return nn}const sn=new Ye(ut.comparator);function on(...t){let e=sn;for(const n of t)e=e.add(n);return e}const an=new Ye(V);function cn(){return an}class un{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,hn.createSynthesizedTargetChangeForCurrentChange(t,e)),new un(K.min(),n,cn(),Ze(),on())}}class hn{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new hn(X.EMPTY_BYTE_STRING,e,on(),on(),on())}}class ln{constructor(t,e,n,r){this.$=t,this.removedTargetIds=e,this.key=n,this.O=r}}class dn{constructor(t,e){this.targetId=t,this.F=e}}class fn{constructor(t,e,n=X.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class mn{constructor(){this.M=0,this.L=yn(),this.B=X.EMPTY_BYTE_STRING,this.U=!1,this.q=!0}get current(){return this.U}get resumeToken(){return this.B}get K(){return 0!==this.M}get j(){return this.q}W(t){t.approximateByteSize()>0&&(this.q=!0,this.B=t)}G(){let t=on(),e=on(),n=on();return this.L.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:v()}})),new hn(this.B,this.U,t,e,n)}H(){this.q=!1,this.L=yn()}J(t,e){this.q=!0,this.L=this.L.insert(t,e)}Y(t){this.q=!0,this.L=this.L.remove(t)}X(){this.M+=1}Z(){this.M-=1}tt(){this.q=!0,this.U=!0}}class gn{constructor(t){this.et=t,this.nt=new Map,this.st=Ze(),this.it=pn(),this.rt=new Ye(V)}ot(t){for(const e of t.$)t.O&&t.O.isFoundDocument()?this.at(e,t.O):this.ct(e,t.key,t.O);for(const e of t.removedTargetIds)this.ct(e,t.key,t.O)}ut(t){this.forEachTarget(t,(e=>{const n=this.ht(e);switch(t.state){case 0:this.lt(e)&&n.W(t.resumeToken);break;case 1:n.Z(),n.K||n.H(),n.W(t.resumeToken);break;case 2:n.Z(),n.K||this.removeTarget(e);break;case 3:this.lt(e)&&(n.tt(),n.W(t.resumeToken));break;case 4:this.lt(e)&&(this.ft(e),n.W(t.resumeToken));break;default:v()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.nt.forEach(((t,n)=>{this.lt(n)&&e(n)}))}dt(t){const e=t.targetId,n=t.F.count,r=this.wt(e);if(r){const t=r.target;if(xt(t))if(0===n){const n=new ut(t.path);this.ct(e,n,kt.newNoDocument(n,K.min()))}else I(1===n);else this._t(e)!==n&&(this.ft(e),this.rt=this.rt.add(e))}}gt(t){const e=new Map;this.nt.forEach(((n,r)=>{const s=this.wt(r);if(s){if(n.current&&xt(s.target)){const e=new ut(s.target.path);null!==this.st.get(e)||this.yt(r,e)||this.ct(r,e,kt.newNoDocument(e,t))}n.j&&(e.set(r,n.G()),n.H())}}));let n=on();this.it.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.wt(t);return!e||2===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))}));const r=new un(t,e,this.rt,this.st,n);return this.st=Ze(),this.it=pn(),this.rt=new Ye(V),r}at(t,e){if(!this.lt(t))return;const n=this.yt(t,e.key)?2:0;this.ht(t).J(e.key,n),this.st=this.st.insert(e.key,e),this.it=this.it.insert(e.key,this.Tt(e.key).add(t))}ct(t,e,n){if(!this.lt(t))return;const r=this.ht(t);this.yt(t,e)?r.J(e,1):r.Y(e),this.it=this.it.insert(e,this.Tt(e).delete(t)),n&&(this.st=this.st.insert(e,n))}removeTarget(t){this.nt.delete(t)}_t(t){const e=this.ht(t).G();return this.et.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}X(t){this.ht(t).X()}ht(t){let e=this.nt.get(t);return e||(e=new mn,this.nt.set(t,e)),e}Tt(t){let e=this.it.get(t);return e||(e=new Ye(V),this.it=this.it.insert(t,e)),e}lt(t){const e=null!==this.wt(t);return e||g("WatchChangeAggregator","Detected inactive target",t),e}wt(t){const e=this.nt.get(t);return e&&e.K?null:this.et.Et(t)}ft(t){this.nt.set(t,new mn),this.et.getRemoteKeysForTarget(t).forEach((e=>{this.ct(t,e,null)}))}yt(t,e){return this.et.getRemoteKeysForTarget(t).has(e)}}function pn(){return new Qe(ut.comparator)}function yn(){return new Qe(ut.comparator)}const wn={asc:"ASCENDING",desc:"DESCENDING"},vn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class In{constructor(t,e){this.databaseId=t,this.C=e}}function Tn(t,e){return t.C?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function En(t,e){return t.C?e.toBase64():e.toUint8Array()}function bn(t,e){return Tn(t,e.toTimestamp())}function Sn(t){return I(!!t),K.fromTimestamp(function(t){const e=tt(t);return new B(e.seconds,e.nanos)}(t))}function _n(t,e){return function(t){return new Q(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function kn(t){const e=Q.fromString(t);return I(Yn(e)),e}function An(t,e){return _n(t.databaseId,e.path)}function Nn(t,e){const n=kn(e);if(n.get(1)!==t.databaseId.projectId)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new ut(Rn(n))}function Dn(t,e){return _n(t.databaseId,e)}function Cn(t){const e=kn(t);return 4===e.length?Q.emptyPath():Rn(e)}function xn(t){return new Q(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Rn(t){return I(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Ln(t,e,n){return{name:An(t,e),fields:n.value.mapValue.fields}}function Fn(t,e,n){const r=Nn(t,e.name),s=Sn(e.updateTime),i=new St({mapValue:{fields:e.fields}}),o=kt.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Mn(t,e){let n;if(e instanceof Me)n={update:Ln(t,e.key,e.value)};else if(e instanceof Ue)n={delete:An(t,e.key)};else if(e instanceof Pe)n={update:Ln(t,e.key,e.data),updateMask:Hn(e.fieldMask)};else{if(!(e instanceof Be))return v();n={verify:An(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof ye)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof we)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Ie)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Ee)return{fieldPath:e.field.canonicalString(),increment:n.N};throw v()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:bn(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:v()}(t,e.precondition)),n}function Pn(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Ae.updateTime(Sn(t.updateTime)):void 0!==t.exists?Ae.exists(t.exists):Ae.none()}(e.currentDocument):Ae.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)I("REQUEST_TIME"===e.setToServerValue),n=new ye;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new we(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Ie(t)}else"increment"in e?n=new Ee(t,e.increment):v();const r=H.fromServerFormat(e.fieldPath);return new _e(r,n)}(t,e))):[];if(e.update){e.update.name;const s=Nn(t,e.update.name),i=new St({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Y(e.map((t=>H.fromServerFormat(t))))}(e.updateMask);return new Pe(s,i,t,n,r)}return new Me(s,i,n,r)}if(e.delete){const r=Nn(t,e.delete);return new Ue(r,n)}if(e.verify){const r=Nn(t,e.verify);return new Be(r,n)}return v()}function On(t,e){return{documents:[Dn(t,e.path)]}}function Vn(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=Dn(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Dn(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(Tt(t.value))return{unaryFilter:{field:Gn(t.field),op:"IS_NAN"}};if(It(t.value))return{unaryFilter:{field:Gn(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Tt(t.value))return{unaryFilter:{field:Gn(t.field),op:"IS_NOT_NAN"}};if(It(t.value))return{unaryFilter:{field:Gn(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Gn(t.field),op:jn(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);s&&(n.structuredQuery.where=s);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Gn(t.field),direction:$n(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.C||ot(e)?e:{value:e}}(t,e.limit);return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt=Bn(e.startAt)),e.endAt&&(n.structuredQuery.endAt=Bn(e.endAt)),n}function qn(t){let e=Cn(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){I(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=Un(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new $t(zn(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,ot(e)?null:e}(n.limit));let c=null;n.startAt&&(c=Kn(n.startAt));let u=null;return n.endAt&&(u=Kn(n.endAt)),Wt(e,s,o,i,a,"F",c,u)}function Un(t){return t?void 0!==t.unaryFilter?[Wn(t)]:void 0!==t.fieldFilter?[Qn(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>Un(t))).reduce(((t,e)=>t.concat(e))):v():[]}function Bn(t){return{before:t.before,values:t.position}}function Kn(t){const e=!!t.before,n=t.values||[];return new Bt(n,e)}function $n(t){return wn[t]}function jn(t){return vn[t]}function Gn(t){return{fieldPath:t.canonicalString()}}function zn(t){return H.fromServerFormat(t.fieldPath)}function Qn(t){return Rt.create(zn(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(t.fieldFilter.op),t.fieldFilter.value)}function Wn(t){switch(t.unaryFilter.op){case"IS_NAN":const e=zn(t.unaryFilter.field);return Rt.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=zn(t.unaryFilter.field);return Rt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=zn(t.unaryFilter.field);return Rt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=zn(t.unaryFilter.field);return Rt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function Hn(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Yn(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Jn(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Zn(e)),e=Xn(t.get(n),e);return Zn(e)}function Xn(t,e){let n=e;const r=t.length;for(let s=0;s<r;s++){const e=t.charAt(s);switch(e){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=e}}return n}function Zn(t){return t+"\x01\x01"}function tr(t){const e=t.length;if(I(e>=2),2===e)return I("\x01"===t.charAt(0)&&"\x01"===t.charAt(1)),Q.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf("\x01",i);switch((e<0||e>n)&&v(),t.charAt(e+1)){case"\x01":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=t.substring(i,e),s+="\0";break;case"\x11":s+=t.substring(i,e+1);break;default:v()}i=e+2}return new Q(r)}class er{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class nr{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}nr.store="owner",nr.key="owner";class rr{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}rr.store="mutationQueues",rr.keyPath="userId";class sr{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}sr.store="mutations",sr.keyPath="batchId",sr.userMutationsIndex="userMutationsIndex",sr.userMutationsKeyPath=["userId","batchId"];class ir{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,Jn(e)]}static key(t,e,n){return[t,Jn(e),n]}}ir.store="documentMutations",ir.PLACEHOLDER=new ir;class or{constructor(t,e){this.path=t,this.readTime=e}}class ar{constructor(t,e){this.path=t,this.version=e}}class cr{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}cr.store="remoteDocuments",cr.readTimeIndex="readTimeIndex",cr.readTimeIndexPath="readTime",cr.collectionReadTimeIndex="collectionReadTimeIndex",cr.collectionReadTimeIndexPath=["parentPath","readTime"];class ur{constructor(t){this.byteSize=t}}ur.store="remoteDocumentGlobal",ur.key="remoteDocumentGlobalKey";class hr{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}hr.store="targets",hr.keyPath="targetId",hr.queryTargetsIndexName="queryTargetsIndex",hr.queryTargetsKeyPath=["canonicalId","targetId"];class lr{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}lr.store="targetDocuments",lr.keyPath=["targetId","path"],lr.documentTargetsIndex="documentTargetsIndex",lr.documentTargetsKeyPath=["path","targetId"];class dr{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}dr.key="targetGlobalKey",dr.store="targetGlobal";class fr{constructor(t,e){this.collectionId=t,this.parent=e}}fr.store="collectionParents",fr.keyPath=["collectionId","parent"];class mr{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}mr.store="clientMetadata",mr.keyPath="clientId";class gr{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}gr.store="bundles",gr.keyPath="bundleId";class pr{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}pr.store="namedQueries",pr.keyPath="name";const yr=[rr.store,sr.store,ir.store,cr.store,hr.store,nr.store,dr.store,lr.store,mr.store,ur.store,fr.store,gr.store,pr.store],wr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class vr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}class Ir{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Ir(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof Ir?e:Ir.resolve(e)}catch(t){return Ir.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):Ir.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):Ir.reject(e)}static resolve(t){return new Ir(((e,n)=>{e(t)}))}static reject(t){return new Ir(((e,n)=>{n(t)}))}static waitFor(t){return new Ir(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=Ir.resolve(!1);for(const n of t)e=e.next((t=>t?Ir.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}}class Tr{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.It=new _,this.transaction.oncomplete=()=>{this.It.resolve()},this.transaction.onabort=()=>{e.error?this.It.reject(new Sr(t,e.error)):this.It.resolve()},this.transaction.onerror=e=>{const n=Dr(e.target.error);this.It.reject(new Sr(t,n))}}static open(t,e,n,r){try{return new Tr(e,t.transaction(r,n))}catch(t){throw new Sr(e,t)}}get At(){return this.It.promise}abort(t){t&&this.It.reject(t),this.aborted||(g("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){const e=this.transaction.objectStore(t);return new kr(e)}}class Er{constructor(t,e,n){this.name=t,this.version=e,this.Rt=n,12.2===Er.bt((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return g("SimpleDb","Removing database:",t),Ar(window.indexedDB.deleteDatabase(t)).toPromise()}static Pt(){if(!(0,o.hl)())return!1;if(Er.vt())return!0;const t=(0,o.z$)(),e=Er.bt(t),n=0<e&&e<10,r=Er.Vt(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static vt(){var t;return"undefined"!=typeof c&&"YES"===(null===(t=c.env)||void 0===t?void 0:t.St)}static Dt(t,e){return t.store(e)}static bt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Ct(t){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new Sr(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new S(b.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(b.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new Sr(t,r))},r.onupgradeneeded=t=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.Rt.Nt(e,r.transaction,t.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.kt&&(this.db.onversionchange=t=>this.kt(t)),this.db}xt(t){this.kt=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Ct(t);const e=Tr.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).catch((t=>(e.abort(t),Ir.reject(t)))).toPromise();return i.catch((()=>{})),await e.At,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(g("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class br{constructor(t){this.$t=t,this.Ot=!1,this.Ft=null}get isDone(){return this.Ot}get Mt(){return this.Ft}set cursor(t){this.$t=t}done(){this.Ot=!0}Lt(t){this.Ft=t}delete(){return Ar(this.$t.delete())}}class Sr extends S{constructor(t,e){super(b.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function _r(t){return"IndexedDbTransactionError"===t.name}class kr{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(g("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Ar(n)}add(t){return g("SimpleDb","ADD",this.store.name,t,t),Ar(this.store.add(t))}get(t){return Ar(this.store.get(t)).next((e=>(void 0===e&&(e=null),g("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return g("SimpleDb","DELETE",this.store.name,t),Ar(this.store.delete(t))}count(){return g("SimpleDb","COUNT",this.store.name),Ar(this.store.count())}Bt(t,e){const n=this.cursor(this.options(t,e)),r=[];return this.Ut(n,((t,e)=>{r.push(e)})).next((()=>r))}qt(t,e){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.Kt=!1;const r=this.cursor(n);return this.Ut(r,((t,e,n)=>n.delete()))}jt(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.Ut(r,e)}Qt(t){const e=this.cursor({});return new Ir(((n,r)=>{e.onerror=t=>{const e=Dr(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}Ut(t,e){const n=[];return new Ir(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new br(s),o=e(s.primaryKey,s.value,i);if(o instanceof Ir){const t=o.catch((t=>(i.done(),Ir.reject(t))));n.push(t)}i.isDone?r():null===i.Mt?s.continue():s.continue(i.Mt)}})).next((()=>Ir.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.Kt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Ar(t){return new Ir(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Dr(t.target.error);n(e)}}))}let Nr=!1;function Dr(t){const e=Er.bt((0,o.z$)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Nr||(Nr=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Cr extends vr{constructor(t,e){super(),this.Wt=t,this.currentSequenceNumber=e}}function xr(t,e){const n=E(t);return Er.Dt(n.Wt,e)}class Rr{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let r=0;r<this.mutations.length;r++){const e=this.mutations[r];e.key.isEqual(t.key)&&Ce(e,t,n[r])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&xe(e,t,this.localWriteTime);for(const e of this.mutations)e.key.isEqual(t.key)&&xe(e,t,this.localWriteTime)}applyToLocalDocumentSet(t){this.mutations.forEach((e=>{const n=t.get(e.key),r=n;this.applyToLocalView(r),n.isValidDocument()||r.convertToNoDocument(K.min())}))}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),on())}isEqual(t){return this.batchId===t.batchId&&q(this.mutations,t.mutations,((t,e)=>Le(t,e)))&&q(this.baseMutations,t.baseMutations,((t,e)=>Le(t,e)))}}class Lr{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){I(t.mutations.length===n.length);let r=rn();const s=t.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Lr(t,e,n,r)}}class Fr{constructor(t,e,n,r,s=K.min(),i=K.min(),o=X.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new Fr(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new Fr(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new Fr(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Mr{constructor(t){this.Gt=t}}function Pr(t,e){if(e.document)return Fn(t.Gt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=ut.fromSegments(e.noDocument.path),n=Br(e.noDocument.readTime),r=kt.newNoDocument(t,n);return e.hasCommittedMutations?r.setHasCommittedMutations():r}if(e.unknownDocument){const t=ut.fromSegments(e.unknownDocument.path),n=Br(e.unknownDocument.version);return kt.newUnknownDocument(t,n)}return v()}function Or(t,e,n){const r=Vr(n),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const n=function(t,e){return{name:An(t,e.key),fields:e.data.value.mapValue.fields,updateTime:Tn(t,e.version.toTimestamp())}}(t.Gt,e),i=e.hasCommittedMutations;return new cr(null,null,n,i,r,s)}if(e.isNoDocument()){const t=e.key.path.toArray(),n=Ur(e.version),i=e.hasCommittedMutations;return new cr(null,new or(t,n),null,i,r,s)}if(e.isUnknownDocument()){const t=e.key.path.toArray(),n=Ur(e.version);return new cr(new ar(t,n),null,null,!0,r,s)}return v()}function Vr(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function qr(t){const e=new B(t[0],t[1]);return K.fromTimestamp(e)}function Ur(t){const e=t.toTimestamp();return new er(e.seconds,e.nanoseconds)}function Br(t){const e=new B(t.seconds,t.nanoseconds);return K.fromTimestamp(e)}function Kr(t,e){const n=(e.baseMutations||[]).map((e=>Pn(t.Gt,e)));for(let i=0;i<e.mutations.length-1;++i){const t=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const n=e.mutations[i+1];t.updateTransforms=n.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map((e=>Pn(t.Gt,e))),s=B.fromMillis(e.localWriteTimeMs);return new Rr(e.batchId,s,n,r)}function $r(t){const e=Br(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Br(t.lastLimboFreeSnapshotVersion):K.min();let r;var s;return void 0!==t.query.documents?(I(1===(s=t.query).documents.length),r=ne(Ht(Cn(s.documents[0])))):r=function(t){return ne(qn(t))}(t.query),new Fr(r,t.targetId,0,t.lastListenSequenceNumber,e,n,X.fromBase64String(t.resumeToken))}function jr(t,e){const n=Ur(e.snapshotVersion),r=Ur(e.lastLimboFreeSnapshotVersion);let s;s=xt(e.target)?On(t.Gt,e.target):Vn(t.Gt,e.target);const i=e.resumeToken.toBase64();return new hr(e.targetId,Dt(e.target),n,i,e.sequenceNumber,r,s)}function Gr(t){const e=qn({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?re(e,e.limit,"L"):e}class zr{getBundleMetadata(t,e){return Qr(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Br(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return Qr(t).put({bundleId:(n=e).id,createTime:Ur(Sn(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return Wr(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Gr(e.bundledQuery),readTime:Br(e.readTime)};var e}))}saveNamedQuery(t,e){return Wr(t).put(function(t){return{name:t.name,readTime:Ur(Sn(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function Qr(t){return xr(t,gr.store)}function Wr(t){return xr(t,pr.store)}class Hr{constructor(){this.zt=new Yr}addToCollectionParentIndex(t,e){return this.zt.add(e),Ir.resolve()}getCollectionParents(t,e){return Ir.resolve(this.zt.getEntries(e))}}class Yr{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Ye(Q.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Ye(Q.comparator)).toArray()}}class Jr{constructor(){this.Ht=new Yr}addToCollectionParentIndex(t,e){if(!this.Ht.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.Ht.add(e)}));const s={collectionId:n,parent:Jn(r)};return Xr(t).put(s)}return Ir.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[U(e),""],!1,!0);return Xr(t).Bt(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(tr(r.parent))}return n}))}}function Xr(t){return xr(t,fr.store)}const Zr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ts{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new ts(t,ts.DEFAULT_COLLECTION_PERCENTILE,ts.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function es(t,e,n){const r=t.store(sr.store),s=t.store(ir.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.jt({range:o},((t,e,n)=>(a++,n.delete())));i.push(c.next((()=>{I(1===a)})));const u=[];for(const h of n.mutations){const t=ir.key(e,h.key.path,n.batchId);i.push(s.delete(t)),u.push(h.key)}return Ir.waitFor(i).next((()=>u))}function ns(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw v();e=t.noDocument}return JSON.stringify(e).length}ts.DEFAULT_COLLECTION_PERCENTILE=10,ts.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ts.DEFAULT=new ts(41943040,ts.DEFAULT_COLLECTION_PERCENTILE,ts.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ts.DISABLED=new ts(-1,0,0);class rs{constructor(t,e,n,r){this.userId=t,this.k=e,this.Jt=n,this.referenceDelegate=r,this.Yt={}}static Xt(t,e,n,r){I(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new rs(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return is(t).jt({index:sr.userMutationsIndex,range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=os(t),i=is(t);return i.add({}).next((o=>{I("number"==typeof o);const a=new Rr(o,e,n,r),c=function(t,e,n){const r=n.baseMutations.map((e=>Mn(t.Gt,e))),s=n.mutations.map((e=>Mn(t.Gt,e)));return new sr(e,n.batchId,n.localWriteTime.toMillis(),r,s)}(this.k,this.userId,a),u=[];let h=new Ye(((t,e)=>V(t.canonicalString(),e.canonicalString())));for(const t of r){const e=ir.key(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),u.push(i.put(c)),u.push(s.put(e,ir.PLACEHOLDER))}return h.forEach((e=>{u.push(this.Jt.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Yt[o]=a.keys()})),Ir.waitFor(u).next((()=>a))}))}lookupMutationBatch(t,e){return is(t).get(e).next((t=>t?(I(t.userId===this.userId),Kr(this.k,t)):null))}Zt(t,e){return this.Yt[e]?Ir.resolve(this.Yt[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Yt[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return is(t).jt({index:sr.userMutationsIndex,range:r},((t,e,r)=>{e.userId===this.userId&&(I(e.batchId>=n),s=Kr(this.k,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return is(t).jt({index:sr.userMutationsIndex,range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return is(t).Bt(sr.userMutationsIndex,e).next((t=>t.map((t=>Kr(this.k,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=ir.prefixForPath(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return os(t).jt({range:r},((n,r,i)=>{const[o,a,c]=n,u=tr(a);if(o===this.userId&&e.path.isEqual(u))return is(t).get(c).next((t=>{if(!t)throw v();I(t.userId===this.userId),s.push(Kr(this.k,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ye(V);const r=[];return e.forEach((e=>{const s=ir.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=os(t).jt({range:i},((t,r,s)=>{const[i,o,a]=t,c=tr(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),Ir.waitFor(r).next((()=>this.te(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=ir.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Ye(V);return os(t).jt({range:i},((t,e,s)=>{const[i,a,c]=t,u=tr(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.te(t,o)))}te(t,e){const n=[],r=[];return e.forEach((e=>{r.push(is(t).get(e).next((t=>{if(null===t)throw v();I(t.userId===this.userId),n.push(Kr(this.k,t))})))})),Ir.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return es(t.Wt,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.ee(e.batchId)})),Ir.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}ee(t){delete this.Yt[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return Ir.resolve();const n=IDBKeyRange.lowerBound(ir.prefixForUser(this.userId)),r=[];return os(t).jt({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=tr(t[1]);r.push(e)}else n.done()})).next((()=>{I(0===r.length)}))}))}containsKey(t,e){return ss(t,this.userId,e)}ne(t){return as(t).get(this.userId).next((t=>t||new rr(this.userId,-1,"")))}}function ss(t,e,n){const r=ir.prefixForPath(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return os(t).jt({range:i,Kt:!0},((t,n,r)=>{const[i,a,c]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function is(t){return xr(t,sr.store)}function os(t){return xr(t,ir.store)}function as(t){return xr(t,rr.store)}class cs{constructor(t){this.se=t}next(){return this.se+=2,this.se}static ie(){return new cs(0)}static re(){return new cs(-1)}}class us{constructor(t,e){this.referenceDelegate=t,this.k=e}allocateTargetId(t){return this.oe(t).next((e=>{const n=new cs(e.highestTargetId);return e.highestTargetId=n.next(),this.ae(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.oe(t).next((t=>K.fromTimestamp(new B(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.oe(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.oe(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.ae(t,r))))}addTargetData(t,e){return this.ce(t,e).next((()=>this.oe(t).next((n=>(n.targetCount+=1,this.ue(e,n),this.ae(t,n))))))}updateTargetData(t,e){return this.ce(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>hs(t).delete(e.targetId))).next((()=>this.oe(t))).next((e=>(I(e.targetCount>0),e.targetCount-=1,this.ae(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return hs(t).jt(((i,o)=>{const a=$r(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>Ir.waitFor(s))).next((()=>r))}forEachTarget(t,e){return hs(t).jt(((t,n)=>{const r=$r(n);e(r)}))}oe(t){return ls(t).get(dr.key).next((t=>(I(null!==t),t)))}ae(t,e){return ls(t).put(dr.key,e)}ce(t,e){return hs(t).put(jr(this.k,e))}ue(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.oe(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Dt(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return hs(t).jt({range:r,index:hr.queryTargetsIndexName},((t,n,r)=>{const i=$r(n);Ct(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=ds(t);return e.forEach((e=>{const i=Jn(e.path);r.push(s.put(new lr(n,i))),r.push(this.referenceDelegate.addReference(t,n,e))})),Ir.waitFor(r)}removeMatchingKeys(t,e,n){const r=ds(t);return Ir.forEach(e,(e=>{const s=Jn(e.path);return Ir.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=ds(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=ds(t);let s=on();return r.jt({range:n,Kt:!0},((t,e,n)=>{const r=tr(t[1]),i=new ut(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=Jn(e.path),r=IDBKeyRange.bound([n],[U(n)],!1,!0);let s=0;return ds(t).jt({index:lr.documentTargetsIndex,Kt:!0,range:r},(([t,e],n,r)=>{0!==t&&(s++,r.done())})).next((()=>s>0))}Et(t,e){return hs(t).get(e).next((t=>t?$r(t):null))}}function hs(t){return xr(t,hr.store)}function ls(t){return xr(t,dr.store)}function ds(t){return xr(t,lr.store)}async function fs(t){if(t.code!==b.FAILED_PRECONDITION||t.message!==wr)throw t;g("LocalStore","Unexpectedly lost primary lease")}function ms([t,e],[n,r]){const s=V(t,n);return 0===s?V(e,r):s}class gs{constructor(t){this.he=t,this.buffer=new Ye(ms),this.le=0}fe(){return++this.le}de(t){const e=[t,this.fe()];if(this.buffer.size<this.he)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();ms(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class ps{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.we=!1,this._e=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.me(t)}stop(){this._e&&(this._e.cancel(),this._e=null)}get started(){return null!==this._e}me(t){const e=this.we?3e5:6e4;g("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this._e=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this._e=null,this.we=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){_r(t)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await fs(t)}await this.me(t)}))}}class ys{constructor(t,e){this.ge=t,this.params=e}calculateTargetCount(t,e){return this.ge.ye(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return Ir.resolve(M.I);const n=new gs(e);return this.ge.forEachTarget(t,(t=>n.de(t.sequenceNumber))).next((()=>this.ge.pe(t,(t=>n.de(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.ge.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.ge.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),Ir.resolve(Zr)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Zr):this.Te(t,e)))}getCacheSize(t){return this.ge.getCacheSize(t)}Te(t,e){let n,r,s,o,a,c,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,o=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,c=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${t} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),Ir.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}class ws{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new ys(t,e)}(this,e)}ye(t){const e=this.Ee(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Ee(t){let e=0;return this.pe(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}pe(t,e){return this.Ie(t,((t,n)=>e(n)))}addReference(t,e,n){return vs(t,n)}removeReference(t,e,n){return vs(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return vs(t,e)}Ae(t,e){return function(t,e){let n=!1;return as(t).Qt((r=>ss(t,r,e).next((t=>(t&&(n=!0),Ir.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Ie(t,((i,o)=>{if(o<=e){const e=this.Ae(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i),ds(t).delete([0,Jn(i.path)]))))}));r.push(e)}})).next((()=>Ir.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return vs(t,e)}Ie(t,e){const n=ds(t);let r,s=M.I;return n.jt({index:lr.documentTargetsIndex},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==M.I&&e(new ut(tr(r)),s),s=o,r=i):s=M.I})).next((()=>{s!==M.I&&e(new ut(tr(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function vs(t,e){return ds(t).put(function(t,e){return new lr(0,Jn(t.path),e)}(e,t.currentSequenceNumber))}class Is{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1}forEach(t){j(this.inner,((e,n)=>{for(const[r,s]of n)t(r,s)}))}isEmpty(){return G(this.inner)}}class Ts{constructor(){this.changes=new Is((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}getReadTime(t){const e=this.changes.get(t);return e?e.readTime:K.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:kt.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Ir.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Es{constructor(t,e){this.k=t,this.Jt=e}addEntry(t,e,n){return _s(t).put(ks(e),n)}removeEntry(t,e){const n=_s(t),r=ks(e);return n.delete(r)}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Re(t,n))))}getEntry(t,e){return _s(t).get(ks(e)).next((t=>this.be(e,t)))}Pe(t,e){return _s(t).get(ks(e)).next((t=>({document:this.be(e,t),size:ns(t)})))}getEntries(t,e){let n=Ze();return this.ve(t,e,((t,e)=>{const r=this.be(t,e);n=n.insert(t,r)})).next((()=>n))}Ve(t,e){let n=Ze(),r=new Qe(ut.comparator);return this.ve(t,e,((t,e)=>{const s=this.be(t,e);n=n.insert(t,s),r=r.insert(t,ns(e))})).next((()=>({documents:n,Se:r})))}ve(t,e,n){if(e.isEmpty())return Ir.resolve();const r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),s=e.getIterator();let i=s.getNext();return _s(t).jt({range:r},((t,e,r)=>{const o=ut.fromSegments(t);for(;i&&ut.comparator(i,o)<0;)n(i,null),i=s.getNext();i&&i.isEqual(o)&&(n(i,e),i=s.hasNext()?s.getNext():null),i?r.Lt(i.path.toArray()):r.done()})).next((()=>{for(;i;)n(i,null),i=s.hasNext()?s.getNext():null}))}getDocumentsMatchingQuery(t,e,n){let r=Ze();const s=e.path.length+1,i={};if(n.isEqual(K.min())){const t=e.path.toArray();i.range=IDBKeyRange.lowerBound(t)}else{const t=e.path.toArray(),r=Vr(n);i.range=IDBKeyRange.lowerBound([t,r],!0),i.index=cr.collectionReadTimeIndex}return _s(t).jt(i,((t,n,i)=>{if(t.length!==s)return;const o=Pr(this.k,n);e.path.isPrefixOf(o.key.path)?ae(e,o)&&(r=r.insert(o.key,o)):i.done()})).next((()=>r))}newChangeBuffer(t){return new bs(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Ss(t).get(ur.key).next((t=>(I(!!t),t)))}Re(t,e){return Ss(t).put(ur.key,e)}be(t,e){if(e){const t=Pr(this.k,e);if(!t.isNoDocument()||!t.version.isEqual(K.min()))return t}return kt.newInvalidDocument(t)}}class bs extends Ts{constructor(t,e){super(),this.De=t,this.trackRemovals=e,this.Ce=new Is((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new Ye(((t,e)=>V(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Ce.get(s);if(i.document.isValidDocument()){const a=Or(this.De.k,i.document,this.getReadTime(s));r=r.add(s.path.popLast());const c=ns(a);n+=c-o,e.push(this.De.addEntry(t,s,a))}else if(n-=o,this.trackRemovals){const n=Or(this.De.k,kt.newNoDocument(s,K.min()),this.getReadTime(s));e.push(this.De.addEntry(t,s,n))}else e.push(this.De.removeEntry(t,s))})),r.forEach((n=>{e.push(this.De.Jt.addToCollectionParentIndex(t,n))})),e.push(this.De.updateMetadata(t,n)),Ir.waitFor(e)}getFromCache(t,e){return this.De.Pe(t,e).next((t=>(this.Ce.set(e,t.size),t.document)))}getAllFromCache(t,e){return this.De.Ve(t,e).next((({documents:t,Se:e})=>(e.forEach(((t,e)=>{this.Ce.set(t,e)})),t)))}}function Ss(t){return xr(t,ur.store)}function _s(t){return xr(t,cr.store)}function ks(t){return t.path.toArray()}class As{constructor(t){this.k=t}Nt(t,e,n,r){I(n<r&&n>=0&&r<=11);const s=new Tr("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore(nr.store)}(t),function(t){t.createObjectStore(rr.store,{keyPath:rr.keyPath}),t.createObjectStore(sr.store,{keyPath:sr.keyPath,autoIncrement:!0}).createIndex(sr.userMutationsIndex,sr.userMutationsKeyPath,{unique:!0}),t.createObjectStore(ir.store)}(t),Ns(t),function(t){t.createObjectStore(cr.store)}(t));let i=Ir.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore(lr.store),t.deleteObjectStore(hr.store),t.deleteObjectStore(dr.store)}(t),Ns(t)),i=i.next((()=>function(t){const e=t.store(dr.store),n=new dr(0,0,K.min().toTimestamp(),0);return e.put(dr.key,n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store(sr.store).Bt().next((n=>{t.deleteObjectStore(sr.store),t.createObjectStore(sr.store,{keyPath:sr.keyPath,autoIncrement:!0}).createIndex(sr.userMutationsIndex,sr.userMutationsKeyPath,{unique:!0});const r=e.store(sr.store),s=n.map((t=>r.put(t)));return Ir.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore(mr.store,{keyPath:mr.keyPath})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this.Ne(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore(ur.store)}(t),this.ke(s))))),n<7&&r>=7&&(i=i.next((()=>this.xe(s)))),n<8&&r>=8&&(i=i.next((()=>this.$e(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){const e=t.objectStore(cr.store);e.createIndex(cr.readTimeIndex,cr.readTimeIndexPath,{unique:!1}),e.createIndex(cr.collectionReadTimeIndex,cr.collectionReadTimeIndexPath,{unique:!1})}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.Oe(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore(gr.store,{keyPath:gr.keyPath})}(t),function(t){t.createObjectStore(pr.store,{keyPath:pr.keyPath})}(t)}))),i}ke(t){let e=0;return t.store(cr.store).jt(((t,n)=>{e+=ns(n)})).next((()=>{const n=new ur(e);return t.store(ur.store).put(ur.key,n)}))}Ne(t){const e=t.store(rr.store),n=t.store(sr.store);return e.Bt().next((e=>Ir.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.Bt(sr.userMutationsIndex,r).next((n=>Ir.forEach(n,(n=>{I(n.userId===e.userId);const r=Kr(this.k,n);return es(t,e.userId,r).next((()=>{}))}))))}))))}xe(t){const e=t.store(lr.store),n=t.store(cr.store);return t.store(dr.store).get(dr.key).next((t=>{const r=[];return n.jt(((n,s)=>{const i=new Q(n),o=function(t){return[0,Jn(t)]}(i);r.push(e.get(o).next((n=>n?Ir.resolve():(n=>e.put(new lr(0,Jn(n),t.highestListenSequenceNumber)))(i))))})).next((()=>Ir.waitFor(r)))}))}$e(t,e){t.createObjectStore(fr.store,{keyPath:fr.keyPath});const n=e.store(fr.store),r=new Yr,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Jn(r)})}};return e.store(cr.store).jt({Kt:!0},((t,e)=>{const n=new Q(t);return s(n.popLast())})).next((()=>e.store(ir.store).jt({Kt:!0},(([t,e,n],r)=>{const i=tr(e);return s(i.popLast())}))))}Oe(t){const e=t.store(hr.store);return e.jt(((t,n)=>{const r=$r(n),s=jr(this.k,r);return e.put(s)}))}}function Ns(t){t.createObjectStore(lr.store,{keyPath:lr.keyPath}).createIndex(lr.documentTargetsIndex,lr.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(hr.store,{keyPath:hr.keyPath}).createIndex(hr.queryTargetsIndexName,hr.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(dr.store)}const Ds="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Cs{constructor(t,e,n,r,s,i,o,a,c,u){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Fe=s,this.window=i,this.document=o,this.Me=c,this.Le=u,this.Be=null,this.Ue=!1,this.isPrimary=!1,this.networkEnabled=!0,this.qe=null,this.inForeground=!1,this.Ke=null,this.je=null,this.Qe=Number.NEGATIVE_INFINITY,this.We=t=>Promise.resolve(),!Cs.Pt())throw new S(b.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ws(this,r),this.Ge=e+"main",this.k=new Mr(a),this.ze=new Er(this.Ge,11,new As(this.k)),this.He=new us(this.referenceDelegate,this.k),this.Jt=new Jr,this.Je=function(t,e){return new Es(t,e)}(this.k,this.Jt),this.Ye=new zr,this.window&&this.window.localStorage?this.Xe=this.window.localStorage:(this.Xe=null,!1===u&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ze().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,Ds);return this.tn(),this.en(),this.nn(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.He.getHighestSequenceNumber(t)))})).then((t=>{this.Be=new M(t,this.Me)})).then((()=>{this.Ue=!0})).catch((t=>(this.ze&&this.ze.close(),Promise.reject(t))))}sn(t){return this.We=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ze.xt((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Fe.enqueueAndForget((async()=>{this.started&&await this.Ze()})))}Ze(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>Rs(t).put(new mr(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next((()=>{if(this.isPrimary)return this.rn(t).next((t=>{t||(this.isPrimary=!1,this.Fe.enqueueRetryable((()=>this.We(!1))))}))})).next((()=>this.on(t))).next((e=>this.isPrimary&&!e?this.an(t).next((()=>!1)):!!e&&this.cn(t).next((()=>!0)))))).catch((t=>{if(_r(t))return g("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Fe.enqueueRetryable((()=>this.We(t))),this.isPrimary=t}))}rn(t){return xs(t).get(nr.key).next((t=>Ir.resolve(this.un(t))))}hn(t){return Rs(t).delete(this.clientId)}async ln(){if(this.isPrimary&&!this.fn(this.Qe,18e5)){this.Qe=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=xr(t,mr.store);return e.Bt().next((t=>{const n=this.dn(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return Ir.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.Xe)for(const e of t)this.Xe.removeItem(this.wn(e.clientId))}}nn(){this.je=this.Fe.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ze().then((()=>this.ln())).then((()=>this.nn()))))}un(t){return!!t&&t.ownerId===this.clientId}on(t){return this.Le?Ir.resolve(!0):xs(t).get(nr.key).next((e=>{if(null!==e&&this.fn(e.leaseTimestampMs,5e3)&&!this._n(e.ownerId)){if(this.un(e)&&this.networkEnabled)return!0;if(!this.un(e)){if(!e.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,Ds);return!1}}return!(!this.networkEnabled||!this.inForeground)||Rs(t).Bt().next((t=>void 0===this.dn(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&g("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Ue=!1,this.mn(),this.je&&(this.je.cancel(),this.je=null),this.gn(),this.yn(),await this.ze.runTransaction("shutdown","readwrite",[nr.store,mr.store],(t=>{const e=new Cr(t,M.I);return this.an(e).next((()=>this.hn(e)))})),this.ze.close(),this.pn()}dn(t,e){return t.filter((t=>this.fn(t.updateTimeMs,e)&&!this._n(t.clientId)))}Tn(){return this.runTransaction("getActiveClients","readonly",(t=>Rs(t).Bt().next((t=>this.dn(t,18e5).map((t=>t.clientId))))))}get started(){return this.Ue}getMutationQueue(t){return rs.Xt(t,this.k,this.Jt,this.referenceDelegate)}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getIndexManager(){return this.Jt}getBundleCache(){return this.Ye}runTransaction(t,e,n){g("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite";let s;return this.ze.runTransaction(t,r,yr,(r=>(s=new Cr(r,this.Be?this.Be.next():M.I),"readwrite-primary"===e?this.rn(s).next((t=>!!t||this.on(s))).next((e=>{if(!e)throw p(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Fe.enqueueRetryable((()=>this.We(!1))),new S(b.FAILED_PRECONDITION,wr);return n(s)})).next((t=>this.cn(s).next((()=>t)))):this.En(s).next((()=>n(s)))))).then((t=>(s.raiseOnCommittedEvent(),t)))}En(t){return xs(t).get(nr.key).next((t=>{if(null!==t&&this.fn(t.leaseTimestampMs,5e3)&&!this._n(t.ownerId)&&!this.un(t)&&!(this.Le||this.allowTabSynchronization&&t.allowTabSynchronization))throw new S(b.FAILED_PRECONDITION,Ds)}))}cn(t){const e=new nr(this.clientId,this.allowTabSynchronization,Date.now());return xs(t).put(nr.key,e)}static Pt(){return Er.Pt()}an(t){const e=xs(t);return e.get(nr.key).next((t=>this.un(t)?(g("IndexedDbPersistence","Releasing primary lease."),e.delete(nr.key)):Ir.resolve()))}fn(t,e){const n=Date.now();return!(t<n-e)&&(!(t>n)||(p(`Detected an update time that is in the future: ${t} > ${n}`),!1))}tn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ke=()=>{this.Fe.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ze())))},this.document.addEventListener("visibilitychange",this.Ke),this.inForeground="visible"===this.document.visibilityState)}gn(){this.Ke&&(this.document.removeEventListener("visibilitychange",this.Ke),this.Ke=null)}en(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.qe=()=>{this.mn(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Fe.enterRestrictedMode(!0),this.Fe.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.qe))}yn(){this.qe&&(this.window.removeEventListener("pagehide",this.qe),this.qe=null)}_n(t){var e;try{const n=null!==(null===(e=this.Xe)||void 0===e?void 0:e.getItem(this.wn(t)));return g("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return p("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}mn(){if(this.Xe)try{this.Xe.setItem(this.wn(this.clientId),String(Date.now()))}catch(t){p("Failed to set zombie client id.",t)}}pn(){if(this.Xe)try{this.Xe.removeItem(this.wn(this.clientId))}catch(t){}}wn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function xs(t){return xr(t,nr.store)}function Rs(t){return xr(t,mr.store)}function Ls(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class Fs{constructor(t,e){this.progress=t,this.In=e}}class Ms{constructor(t,e,n){this.Je=t,this.An=e,this.Jt=n}Rn(t,e){return this.An.getAllMutationBatchesAffectingDocumentKey(t,e).next((n=>this.bn(t,e,n)))}bn(t,e,n){return this.Je.getEntry(t,e).next((t=>{for(const e of n)e.applyToLocalView(t);return t}))}Pn(t,e){t.forEach(((t,n)=>{for(const r of e)r.applyToLocalView(n)}))}vn(t,e){return this.Je.getEntries(t,e).next((e=>this.Vn(t,e).next((()=>e))))}Vn(t,e){return this.An.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>this.Pn(e,t)))}getDocumentsMatchingQuery(t,e,n){return function(t){return ut.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.Sn(t,e.path):te(e)?this.Dn(t,e,n):this.Cn(t,e,n)}Sn(t,e){return this.Rn(t,new ut(e)).next((t=>{let e=en();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}Dn(t,e,n){const r=e.collectionGroup;let s=en();return this.Jt.getCollectionParents(t,r).next((i=>Ir.forEach(i,(i=>{const o=function(t,e){return new Qt(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(r));return this.Cn(t,o,n).next((t=>{t.forEach(((t,e)=>{s=s.insert(t,e)}))}))})).next((()=>s))))}Cn(t,e,n){let r,s;return this.Je.getDocumentsMatchingQuery(t,e,n).next((n=>(r=n,this.An.getAllMutationBatchesAffectingQuery(t,e)))).next((e=>(s=e,this.Nn(t,s,r).next((t=>{r=t;for(const e of s)for(const t of e.mutations){const n=t.key;let s=r.get(n);null==s&&(s=kt.newInvalidDocument(n),r=r.insert(n,s)),xe(t,s,e.localWriteTime),s.isFoundDocument()||(r=r.remove(n))}}))))).next((()=>(r.forEach(((t,n)=>{ae(e,n)||(r=r.remove(t))})),r)))}Nn(t,e,n){let r=on();for(const i of e)for(const t of i.mutations)t instanceof Pe&&null===n.get(t.key)&&(r=r.add(t.key));let s=n;return this.Je.getEntries(t,r).next((t=>(t.forEach(((t,e)=>{e.isFoundDocument()&&(s=s.insert(t,e))})),s)))}}class Ps{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.kn=n,this.xn=r}static $n(t,e){let n=on(),r=on();for(const s of e.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new Ps(t,e.fromCache,n,r)}}class Os{On(t){this.Fn=t}getDocumentsMatchingQuery(t,e,n,r){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||n.isEqual(K.min())?this.Mn(t,e):this.Fn.vn(t,r).next((s=>{const o=this.Ln(e,s);return(Yt(e)||Jt(e))&&this.Bn(e.limitType,o,r,n)?this.Mn(t,e):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),oe(e)),this.Fn.getDocumentsMatchingQuery(t,e,n).next((t=>(o.forEach((e=>{t=t.insert(e.key,e)})),t))))}))}Ln(t,e){let n=new Ye(ce(t));return e.forEach(((e,r)=>{ae(t,r)&&(n=n.add(r))})),n}Bn(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Mn(t,e){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",oe(e)),this.Fn.getDocumentsMatchingQuery(t,e,K.min())}}class Vs{constructor(t,e,n,r){this.persistence=t,this.Un=e,this.k=r,this.qn=new Qe(V),this.Kn=new Is((t=>Dt(t)),Ct),this.jn=K.min(),this.An=t.getMutationQueue(n),this.Qn=t.getRemoteDocumentCache(),this.He=t.getTargetCache(),this.Wn=new Ms(this.Qn,this.An,this.persistence.getIndexManager()),this.Ye=t.getBundleCache(),this.Un.On(this.Wn)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.qn)))}}function qs(t,e,n,r){return new Vs(t,e,n,r)}async function Us(t,e){const n=E(t);let r=n.An,s=n.Wn;const i=await n.persistence.runTransaction("Handle user change","readonly",(t=>{let i;return n.An.getAllMutationBatches(t).next((o=>(i=o,r=n.persistence.getMutationQueue(e),s=new Ms(n.Qn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(t)))).next((e=>{const n=[],r=[];let o=on();for(const t of i){n.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return s.vn(t,o).next((t=>({Gn:t,removedBatchIds:n,addedBatchIds:r})))}))}));return n.An=r,n.Wn=s,n.Un.On(n.Wn),i}function Bs(t){const e=E(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.He.getLastRemoteSnapshotVersion(t)))}function Ks(t,e,n,r,s){let i=on();return n.forEach((t=>i=i.add(t))),e.getEntries(t,i).next((t=>{let i=Ze();return n.forEach(((n,o)=>{const a=t.get(n),c=(null==s?void 0:s.get(n))||r;o.isNoDocument()&&o.version.isEqual(K.min())?(e.removeEntry(n,c),i=i.insert(n,o)):!a.isValidDocument()||o.version.compareTo(a.version)>0||0===o.version.compareTo(a.version)&&a.hasPendingWrites?(e.addEntry(o,c),i=i.insert(n,o)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",o.version)})),i}))}function $s(t,e){const n=E(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.An.getNextMutationBatchAfterBatchId(t,e))))}function js(t,e){const n=E(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.He.getTargetData(t,e).next((s=>s?(r=s,Ir.resolve(r)):n.He.allocateTargetId(t).next((s=>(r=new Fr(e,s,0,t.currentSequenceNumber),n.He.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.qn.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.qn=n.qn.insert(t.targetId,t),n.Kn.set(e,t.targetId)),t}))}async function Gs(t,e,n){const r=E(t),s=r.qn.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!_r(t))throw t;g("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.qn=r.qn.remove(e),r.Kn.delete(s.target)}function zs(t,e,n){const r=E(t);let s=K.min(),i=on();return r.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const r=E(t),s=r.Kn.get(n);return void 0!==s?Ir.resolve(r.qn.get(s)):r.He.getTargetData(e,n)}(r,t,ne(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.He.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.Un.getDocumentsMatchingQuery(t,e,n?s:K.min(),n?i:on()))).next((t=>({documents:t,zn:i})))))}function Qs(t,e){const n=E(t),r=E(n.He),s=n.qn.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r.Et(t,e).next((t=>t?t.target:null))))}function Ws(t){const e=E(t);return e.persistence.runTransaction("Get new document changes","readonly",(t=>function(t,e,n){const r=E(t);let s=Ze(),i=Vr(n);const o=_s(e),a=IDBKeyRange.lowerBound(i,!0);return o.jt({index:cr.readTimeIndex,range:a},((t,e)=>{const n=Pr(r.k,e);s=s.insert(n.key,n),i=e.readTime})).next((()=>({In:s,readTime:qr(i)})))}(e.Qn,t,e.jn))).then((({In:t,readTime:n})=>(e.jn=n,t)))}async function Hs(t,e,n=on()){const r=await js(t,ne(Gr(e.bundledQuery))),s=E(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Sn(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ye.saveNamedQuery(t,e);const o=r.withResumeToken(X.EMPTY_BYTE_STRING,i);return s.qn=s.qn.insert(o.targetId,o),s.He.updateTargetData(t,o).next((()=>s.He.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.He.addMatchingKeys(t,n,r.targetId))).next((()=>s.Ye.saveNamedQuery(t,e)))}))}class Ys{constructor(t){this.k=t,this.Xn=new Map,this.Zn=new Map}getBundleMetadata(t,e){return Ir.resolve(this.Xn.get(e))}saveBundleMetadata(t,e){var n;return this.Xn.set(e.id,{id:(n=e).id,version:n.version,createTime:Sn(n.createTime)}),Ir.resolve()}getNamedQuery(t,e){return Ir.resolve(this.Zn.get(e))}saveNamedQuery(t,e){return this.Zn.set(e.name,function(t){return{name:t.name,query:Gr(t.bundledQuery),readTime:Sn(t.readTime)}}(e)),Ir.resolve()}}class Js{constructor(){this.ts=new Ye(Xs.es),this.ns=new Ye(Xs.ss)}isEmpty(){return this.ts.isEmpty()}addReference(t,e){const n=new Xs(t,e);this.ts=this.ts.add(n),this.ns=this.ns.add(n)}rs(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.os(new Xs(t,e))}cs(t,e){t.forEach((t=>this.removeReference(t,e)))}us(t){const e=new ut(new Q([])),n=new Xs(e,t),r=new Xs(e,t+1),s=[];return this.ns.forEachInRange([n,r],(t=>{this.os(t),s.push(t.key)})),s}hs(){this.ts.forEach((t=>this.os(t)))}os(t){this.ts=this.ts.delete(t),this.ns=this.ns.delete(t)}ls(t){const e=new ut(new Q([])),n=new Xs(e,t),r=new Xs(e,t+1);let s=on();return this.ns.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Xs(t,0),n=this.ts.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Xs{constructor(t,e){this.key=t,this.fs=e}static es(t,e){return ut.comparator(t.key,e.key)||V(t.fs,e.fs)}static ss(t,e){return V(t.fs,e.fs)||ut.comparator(t.key,e.key)}}class Zs{constructor(t,e){this.Jt=t,this.referenceDelegate=e,this.An=[],this.ds=1,this.ws=new Ye(Xs.es)}checkEmpty(t){return Ir.resolve(0===this.An.length)}addMutationBatch(t,e,n,r){const s=this.ds;this.ds++,this.An.length>0&&this.An[this.An.length-1];const i=new Rr(s,e,n,r);this.An.push(i);for(const o of r)this.ws=this.ws.add(new Xs(o.key,s)),this.Jt.addToCollectionParentIndex(t,o.key.path.popLast());return Ir.resolve(i)}lookupMutationBatch(t,e){return Ir.resolve(this._s(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.gs(n),s=r<0?0:r;return Ir.resolve(this.An.length>s?this.An[s]:null)}getHighestUnacknowledgedBatchId(){return Ir.resolve(0===this.An.length?-1:this.ds-1)}getAllMutationBatches(t){return Ir.resolve(this.An.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Xs(e,0),r=new Xs(e,Number.POSITIVE_INFINITY),s=[];return this.ws.forEachInRange([n,r],(t=>{const e=this._s(t.fs);s.push(e)})),Ir.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Ye(V);return e.forEach((t=>{const e=new Xs(t,0),r=new Xs(t,Number.POSITIVE_INFINITY);this.ws.forEachInRange([e,r],(t=>{n=n.add(t.fs)}))})),Ir.resolve(this.ys(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;ut.isDocumentKey(s)||(s=s.child(""));const i=new Xs(new ut(s),0);let o=new Ye(V);return this.ws.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.fs)),!0)}),i),Ir.resolve(this.ys(o))}ys(t){const e=[];return t.forEach((t=>{const n=this._s(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){I(0===this.ps(e.batchId,"removed")),this.An.shift();let n=this.ws;return Ir.forEach(e.mutations,(r=>{const s=new Xs(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.ws=n}))}ee(t){}containsKey(t,e){const n=new Xs(e,0),r=this.ws.firstAfterOrEqual(n);return Ir.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.An.length,Ir.resolve()}ps(t,e){return this.gs(t)}gs(t){return 0===this.An.length?0:t-this.An[0].batchId}_s(t){const e=this.gs(t);return e<0||e>=this.An.length?null:this.An[e]}}class ti{constructor(t,e){this.Jt=t,this.Ts=e,this.docs=new Qe(ut.comparator),this.size=0}addEntry(t,e,n){const r=e.key,s=this.docs.get(r),i=s?s.size:0,o=this.Ts(e);return this.docs=this.docs.insert(r,{document:e.mutableCopy(),size:o,readTime:n}),this.size+=o-i,this.Jt.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Ir.resolve(n?n.document.mutableCopy():kt.newInvalidDocument(e))}getEntries(t,e){let n=Ze();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():kt.newInvalidDocument(t))})),Ir.resolve(n)}getDocumentsMatchingQuery(t,e,n){let r=Ze();const s=new ut(e.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||ae(e,s)&&(r=r.insert(s.key,s.mutableCopy()))}return Ir.resolve(r)}Es(t,e){return Ir.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new ei(this)}getSize(t){return Ir.resolve(this.size)}}class ei extends Ts{constructor(t){super(),this.De=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.document.isValidDocument()?e.push(this.De.addEntry(t,r.document,this.getReadTime(n))):this.De.removeEntry(n)})),Ir.waitFor(e)}getFromCache(t,e){return this.De.getEntry(t,e)}getAllFromCache(t,e){return this.De.getEntries(t,e)}}class ni{constructor(t){this.persistence=t,this.Is=new Is((t=>Dt(t)),Ct),this.lastRemoteSnapshotVersion=K.min(),this.highestTargetId=0,this.As=0,this.Rs=new Js,this.targetCount=0,this.bs=cs.ie()}forEachTarget(t,e){return this.Is.forEach(((t,n)=>e(n))),Ir.resolve()}getLastRemoteSnapshotVersion(t){return Ir.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Ir.resolve(this.As)}allocateTargetId(t){return this.highestTargetId=this.bs.next(),Ir.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.As&&(this.As=e),Ir.resolve()}ce(t){this.Is.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.bs=new cs(e),this.highestTargetId=e),t.sequenceNumber>this.As&&(this.As=t.sequenceNumber)}addTargetData(t,e){return this.ce(e),this.targetCount+=1,Ir.resolve()}updateTargetData(t,e){return this.ce(e),Ir.resolve()}removeTargetData(t,e){return this.Is.delete(e.target),this.Rs.us(e.targetId),this.targetCount-=1,Ir.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Is.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Is.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),Ir.waitFor(s).next((()=>r))}getTargetCount(t){return Ir.resolve(this.targetCount)}getTargetData(t,e){const n=this.Is.get(e)||null;return Ir.resolve(n)}addMatchingKeys(t,e,n){return this.Rs.rs(e,n),Ir.resolve()}removeMatchingKeys(t,e,n){this.Rs.cs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),Ir.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Rs.us(e),Ir.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Rs.ls(e);return Ir.resolve(n)}containsKey(t,e){return Ir.resolve(this.Rs.containsKey(e))}}class ri{constructor(t,e){this.Ps={},this.Be=new M(0),this.Ue=!1,this.Ue=!0,this.referenceDelegate=t(this),this.He=new ni(this),this.Jt=new Hr,this.Je=function(t,e){return new ti(t,e)}(this.Jt,(t=>this.referenceDelegate.vs(t))),this.k=new Mr(e),this.Ye=new Ys(this.k)}start(){return Promise.resolve()}shutdown(){return this.Ue=!1,Promise.resolve()}get started(){return this.Ue}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Jt}getMutationQueue(t){let e=this.Ps[t.toKey()];return e||(e=new Zs(this.Jt,this.referenceDelegate),this.Ps[t.toKey()]=e),e}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getBundleCache(){return this.Ye}runTransaction(t,e,n){g("MemoryPersistence","Starting transaction:",t);const r=new si(this.Be.next());return this.referenceDelegate.Vs(),n(r).next((t=>this.referenceDelegate.Ss(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Ds(t,e){return Ir.or(Object.values(this.Ps).map((n=>()=>n.containsKey(t,e))))}}class si extends vr{constructor(t){super(),this.currentSequenceNumber=t}}class ii{constructor(t){this.persistence=t,this.Cs=new Js,this.Ns=null}static ks(t){return new ii(t)}get xs(){if(this.Ns)return this.Ns;throw v()}addReference(t,e,n){return this.Cs.addReference(n,e),this.xs.delete(n.toString()),Ir.resolve()}removeReference(t,e,n){return this.Cs.removeReference(n,e),this.xs.add(n.toString()),Ir.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),Ir.resolve()}removeTarget(t,e){this.Cs.us(e.targetId).forEach((t=>this.xs.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.xs.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Vs(){this.Ns=new Set}Ss(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ir.forEach(this.xs,(n=>{const r=ut.fromPath(n);return this.$s(t,r).next((t=>{t||e.removeEntry(r)}))})).next((()=>(this.Ns=null,e.apply(t))))}updateLimboDocument(t,e){return this.$s(t,e).next((t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())}))}vs(t){return 0}$s(t,e){return Ir.or([()=>Ir.resolve(this.Cs.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ds(t,e)])}}function oi(t,e){return`firestore_clients_${t}_${e}`}function ai(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function ci(t,e){return`firestore_targets_${t}_${e}`}class ui{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Os(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new ui(t,e,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Fs(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class hi{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Os(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new hi(t,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Fs(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class li{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Os(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=cn();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=ct(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new li(t,s):(p("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class di{constructor(t,e){this.clientId=t,this.onlineState=e}static Os(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new di(e.clientId,e.onlineState):(p("SharedClientState",`Failed to parse online state: ${t}`),null)}}class fi{constructor(){this.activeTargetIds=cn()}Ms(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ls(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Fs(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class mi{constructor(t,e,n,r,s){this.window=t,this.Fe=e,this.persistenceKey=n,this.Bs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Us=this.qs.bind(this),this.Ks=new Qe(V),this.started=!1,this.js=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Qs=oi(this.persistenceKey,this.Bs),this.Ws=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.Ks=this.Ks.insert(this.Bs,new fi),this.Gs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.zs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Hs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Js=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Ys=function(t){return`firestore_bundle_loaded_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.Us)}static Pt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Tn();for(const n of t){if(n===this.Bs)continue;const t=this.getItem(oi(this.persistenceKey,n));if(t){const e=li.Os(n,t);e&&(this.Ks=this.Ks.insert(e.clientId,e))}}this.Xs();const e=this.storage.getItem(this.Js);if(e){const t=this.Zs(e);t&&this.ti(t)}for(const n of this.js)this.qs(n);this.js=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Ws,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ei(this.Ks)}isActiveQueryTarget(t){let e=!1;return this.Ks.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.ni(t,"pending")}updateMutationState(t,e,n){this.ni(t,e,n),this.si(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(ci(this.persistenceKey,t));if(n){const r=hi.Os(t,n);r&&(e=r.state)}}return this.ii.Ms(t),this.Xs(),e}removeLocalQueryTarget(t){this.ii.Ls(t),this.Xs()}isLocalQueryTarget(t){return this.ii.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(ci(this.persistenceKey,t))}updateQueryState(t,e,n){this.ri(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.si(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.oi(t)}notifyBundleLoaded(){this.ai()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Us),this.removeItem(this.Qs),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return g("SharedClientState","READ",t,e),e}setItem(t,e){g("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){g("SharedClientState","REMOVE",t),this.storage.removeItem(t)}qs(t){const e=t;if(e.storageArea===this.storage){if(g("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Qs)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Fe.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.Gs.test(e.key)){if(null==e.newValue){const t=this.ci(e.key);return this.ui(t,null)}{const t=this.hi(e.key,e.newValue);if(t)return this.ui(t.clientId,t)}}else if(this.zs.test(e.key)){if(null!==e.newValue){const t=this.li(e.key,e.newValue);if(t)return this.fi(t)}}else if(this.Hs.test(e.key)){if(null!==e.newValue){const t=this.di(e.key,e.newValue);if(t)return this.wi(t)}}else if(e.key===this.Js){if(null!==e.newValue){const t=this.Zs(e.newValue);if(t)return this.ti(t)}}else if(e.key===this.Ws){const t=function(t){let e=M.I;if(null!=t)try{const n=JSON.parse(t);I("number"==typeof n),e=n}catch(t){p("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==M.I&&this.sequenceNumberHandler(t)}else if(e.key===this.Ys)return this.syncEngine._i()}else this.js.push(e)}))}}get ii(){return this.Ks.get(this.Bs)}Xs(){this.setItem(this.Qs,this.ii.Fs())}ni(t,e,n){const r=new ui(this.currentUser,t,e,n),s=ai(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Fs())}si(t){const e=ai(this.persistenceKey,this.currentUser,t);this.removeItem(e)}oi(t){const e={clientId:this.Bs,onlineState:t};this.storage.setItem(this.Js,JSON.stringify(e))}ri(t,e,n){const r=ci(this.persistenceKey,t),s=new hi(t,e,n);this.setItem(r,s.Fs())}ai(){this.setItem(this.Ys,"value-not-used")}ci(t){const e=this.Gs.exec(t);return e?e[1]:null}hi(t,e){const n=this.ci(t);return li.Os(n,e)}li(t,e){const n=this.zs.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ui.Os(new h(s),r,e)}di(t,e){const n=this.Hs.exec(t),r=Number(n[1]);return hi.Os(r,e)}Zs(t){return di.Os(t)}async fi(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.mi(t.batchId,t.state,t.error);g("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}wi(t){return this.syncEngine.gi(t.targetId,t.state,t.error)}ui(t,e){const n=e?this.Ks.insert(t,e):this.Ks.remove(t),r=this.ei(this.Ks),s=this.ei(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.yi(i,o).then((()=>{this.Ks=n}))}ti(t){this.Ks.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ei(t){let e=cn();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class gi{constructor(){this.pi=new fi,this.Ti={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.pi.Ms(t),this.Ti[t]||"not-current"}updateQueryState(t,e,n){this.Ti[t]=e}removeLocalQueryTarget(t){this.pi.Ls(t)}isLocalQueryTarget(t){return this.pi.activeTargetIds.has(t)}clearQueryState(t){delete this.Ti[t]}getAllActiveQueryTargets(){return this.pi.activeTargetIds}isActiveQueryTarget(t){return this.pi.activeTargetIds.has(t)}start(){return this.pi=new fi,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class pi{Ei(t){}shutdown(){}}class yi{constructor(){this.Ii=()=>this.Ai(),this.Ri=()=>this.bi(),this.Pi=[],this.vi()}Ei(t){this.Pi.push(t)}shutdown(){window.removeEventListener("online",this.Ii),window.removeEventListener("offline",this.Ri)}vi(){window.addEventListener("online",this.Ii),window.addEventListener("offline",this.Ri)}Ai(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Pi)t(0)}bi(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Pi)t(1)}static Pt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const wi={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class vi{constructor(t){this.Vi=t.Vi,this.Si=t.Si}Di(t){this.Ci=t}Ni(t){this.ki=t}onMessage(t){this.xi=t}close(){this.Si()}send(t){this.Vi(t)}$i(){this.Ci()}Oi(t){this.ki(t)}Fi(t){this.xi(t)}}class Ii extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.Mi=e+"://"+t.host,this.Li="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Bi(t,e,n,r,s){const i=this.Ui(t,e);g("RestConnection","Sending: ",i,n);const o={};return this.qi(o,r,s),this.Ki(t,i,o,n).then((t=>(g("RestConnection","Received: ",t),t)),(e=>{throw y("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}ji(t,e,n,r,s){return this.Bi(t,e,n,r,s)}qi(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+l,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}Ui(t,e){const n=wi[t];return`${this.Mi}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}Ki(t,e,n,r){return new Promise(((s,i)=>{const o=new a.JJ;o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const e=o.getResponseJson();g("Connection","XHR received:",JSON.stringify(e)),s(e);break;case a.jK.TIMEOUT:g("Connection",'RPC "'+t+'" timed out'),i(new S(b.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(g("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(b).indexOf(e)>=0?e:b.UNKNOWN}(t.status);i(new S(e,t.message))}else i(new S(b.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new S(b.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g("Connection",'RPC "'+t+'" completed.')}}));const c=JSON.stringify(r);o.send(e,"POST",c,n,15)}))}Qi(t,e,n){const r=[this.Mi,"/","google.firestore.v1.Firestore","/",t,"/channel"],s=(0,a.UE)(),i=(0,a.FJ)(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(c.xmlHttpFactory=new a.zI({})),this.qi(c.initMessageHeaders,e,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(c.httpHeadersOverwriteParam="$httpHeaders");const u=r.join("");g("Connection","Creating WebChannel: "+u,c);const h=s.createWebChannel(u,c);let l=!1,d=!1;const f=new vi({Vi:t=>{d?g("Connection","Not sending because WebChannel is closed:",t):(l||(g("Connection","Opening WebChannel transport."),h.open(),l=!0),g("Connection","WebChannel sending:",t),h.send(t))},Si:()=>h.close()}),m=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return m(h,a.ii.EventType.OPEN,(()=>{d||g("Connection","WebChannel transport opened.")})),m(h,a.ii.EventType.CLOSE,(()=>{d||(d=!0,g("Connection","WebChannel transport closed"),f.Oi())})),m(h,a.ii.EventType.ERROR,(t=>{d||(d=!0,y("Connection","WebChannel transport errored:",t),f.Oi(new S(b.UNAVAILABLE,"The operation could not be completed")))})),m(h,a.ii.EventType.MESSAGE,(t=>{var e;if(!d){const n=t.data[0];I(!!n);const r=n,s=r.error||(null===(e=r[0])||void 0===e?void 0:e.error);if(s){g("Connection","WebChannel received error:",s);const t=s.status;let e=function(t){const e=$e[t];if(void 0!==e)return ze(e)}(t),n=s.message;void 0===e&&(e=b.INTERNAL,n="Unknown error status: "+t+" with message "+s.message),d=!0,f.Oi(new S(e,n)),h.close()}else g("Connection","WebChannel received:",n),f.Fi(n)}})),m(i,a.ju.STAT_EVENT,(t=>{t.stat===a.kN.PROXY?g("Connection","Detected buffering proxy"):t.stat===a.kN.NOPROXY&&g("Connection","Detected no buffering proxy")})),setTimeout((()=>{f.$i()}),0),f}}function Ti(){return"undefined"!=typeof window?window:null}function Ei(){return"undefined"!=typeof document?document:null}function bi(t){return new In(t,!0)}class Si{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Fe=t,this.timerId=e,this.Wi=n,this.Gi=r,this.zi=s,this.Hi=0,this.Ji=null,this.Yi=Date.now(),this.reset()}reset(){this.Hi=0}Xi(){this.Hi=this.zi}Zi(t){this.cancel();const e=Math.floor(this.Hi+this.tr()),n=Math.max(0,Date.now()-this.Yi),r=Math.max(0,e-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Hi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Ji=this.Fe.enqueueAfterDelay(this.timerId,r,(()=>(this.Yi=Date.now(),t()))),this.Hi*=this.Gi,this.Hi<this.Wi&&(this.Hi=this.Wi),this.Hi>this.zi&&(this.Hi=this.zi)}er(){null!==this.Ji&&(this.Ji.skipDelay(),this.Ji=null)}cancel(){null!==this.Ji&&(this.Ji.cancel(),this.Ji=null)}tr(){return(Math.random()-.5)*this.Hi}}class _i{constructor(t,e,n,r,s,i,o,a){this.Fe=t,this.nr=n,this.sr=r,this.ir=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.rr=0,this.ar=null,this.cr=null,this.stream=null,this.ur=new Si(t,e)}hr(){return 1===this.state||5===this.state||this.lr()}lr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.dr()}async stop(){this.hr()&&await this.close(0)}wr(){this.state=0,this.ur.reset()}_r(){this.lr()&&null===this.ar&&(this.ar=this.Fe.enqueueAfterDelay(this.nr,6e4,(()=>this.mr())))}gr(t){this.yr(),this.stream.send(t)}async mr(){if(this.lr())return this.close(0)}yr(){this.ar&&(this.ar.cancel(),this.ar=null)}pr(){this.cr&&(this.cr.cancel(),this.cr=null)}async close(t,e){this.yr(),this.pr(),this.ur.cancel(),this.rr++,4!==t?this.ur.reset():e&&e.code===b.RESOURCE_EXHAUSTED?(p(e.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.ur.Xi()):e&&e.code===b.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Tr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ni(e)}Tr(){}auth(){this.state=1;const t=this.Er(this.rr),e=this.rr;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.rr===e&&this.Ir(t,n)}),(e=>{t((()=>{const t=new S(b.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Ar(t)}))}))}Ir(t,e){const n=this.Er(this.rr);this.stream=this.Rr(t,e),this.stream.Di((()=>{n((()=>(this.state=2,this.cr=this.Fe.enqueueAfterDelay(this.sr,1e4,(()=>(this.lr()&&(this.state=3),Promise.resolve()))),this.listener.Di())))})),this.stream.Ni((t=>{n((()=>this.Ar(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}dr(){this.state=5,this.ur.Zi((async()=>{this.state=0,this.start()}))}Ar(t){return g("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Er(t){return e=>{this.Fe.enqueueAndForget((()=>this.rr===t?e():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ki extends _i{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.k=s}Rr(t,e){return this.ir.Qi("Listen",t,e)}onMessage(t){this.ur.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:v()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.C?(I(void 0===e||"string"==typeof e),X.fromBase64String(e||"")):(I(void 0===e||e instanceof Uint8Array),X.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?b.UNKNOWN:ze(t.code);return new S(e,t.message||"")}(o);n=new fn(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=Nn(t,r.document.name),i=Sn(r.document.updateTime),o=new St({mapValue:{fields:r.document.fields}}),a=kt.newFoundDocument(s,i,o),c=r.targetIds||[],u=r.removedTargetIds||[];n=new ln(c,u,a.key,a)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=Nn(t,r.document),i=r.readTime?Sn(r.readTime):K.min(),o=kt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new ln([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=Nn(t,r.document),i=r.removedTargetIds||[];n=new ln([],i,s,null)}else{if(!("filter"in e))return v();{e.filter;const t=e.filter;t.targetId;const r=t.count||0,s=new Ke(r),i=t.targetId;n=new dn(i,s)}}return n}(this.k,t),n=function(t){if(!("targetChange"in t))return K.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?K.min():e.readTime?Sn(e.readTime):K.min()}(t);return this.listener.br(e,n)}Pr(t){const e={};e.database=xn(this.k),e.addTarget=function(t,e){let n;const r=e.target;return n=xt(r)?{documents:On(t,r)}:{query:Vn(t,r)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=En(t,e.resumeToken):e.snapshotVersion.compareTo(K.min())>0&&(n.readTime=Tn(t,e.snapshotVersion.toTimestamp())),n}(this.k,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.k,t);n&&(e.labels=n),this.gr(e)}vr(t){const e={};e.database=xn(this.k),e.removeTarget=t,this.gr(e)}}class Ai extends _i{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.k=s,this.Vr=!1}get Sr(){return this.Vr}start(){this.Vr=!1,this.lastStreamToken=void 0,super.start()}Tr(){this.Vr&&this.Dr([])}Rr(t,e){return this.ir.Qi("Write",t,e)}onMessage(t){if(I(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Vr){this.ur.reset();const e=function(t,e){return t&&t.length>0?(I(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Sn(t.updateTime):Sn(e);return n.isEqual(K.min())&&(n=Sn(e)),new ke(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Sn(t.commitTime);return this.listener.Cr(n,e)}return I(!t.writeResults||0===t.writeResults.length),this.Vr=!0,this.listener.Nr()}kr(){const t={};t.database=xn(this.k),this.gr(t)}Dr(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Mn(this.k,t)))};this.gr(e)}}class Ni extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.ir=n,this.k=r,this.$r=!1}Or(){if(this.$r)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}Bi(t,e,n){return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.ir.Bi(t,e,n,r,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new S(b.UNKNOWN,t.toString())}))}ji(t,e,n){return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.ir.ji(t,e,n,r,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new S(b.UNKNOWN,t.toString())}))}terminate(){this.$r=!0}}class Di{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Fr=0,this.Mr=null,this.Lr=!0}Br(){0===this.Fr&&(this.Ur("Unknown"),this.Mr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.Mr=null,this.qr("Backend didn't respond within 10 seconds."),this.Ur("Offline"),Promise.resolve()))))}Kr(t){"Online"===this.state?this.Ur("Unknown"):(this.Fr++,this.Fr>=1&&(this.jr(),this.qr(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Ur("Offline")))}set(t){this.jr(),this.Fr=0,"Online"===t&&(this.Lr=!1),this.Ur(t)}Ur(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}qr(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Lr?(p(e),this.Lr=!1):g("OnlineStateTracker",e)}jr(){null!==this.Mr&&(this.Mr.cancel(),this.Mr=null)}}class Ci{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Qr=[],this.Wr=new Map,this.Gr=new Set,this.zr=[],this.Hr=s,this.Hr.Ei((t=>{n.enqueueAndForget((async()=>{qi(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=E(t);e.Gr.add(4),await Ri(e),e.Jr.set("Unknown"),e.Gr.delete(4),await xi(e)}(this))}))})),this.Jr=new Di(n,r)}}async function xi(t){if(qi(t))for(const e of t.zr)await e(!0)}async function Ri(t){for(const e of t.zr)await e(!1)}function Li(t,e){const n=E(t);n.Wr.has(e.targetId)||(n.Wr.set(e.targetId,e),Vi(n)?Oi(n):no(n).lr()&&Mi(n,e))}function Fi(t,e){const n=E(t),r=no(n);n.Wr.delete(e),r.lr()&&Pi(n,e),0===n.Wr.size&&(r.lr()?r._r():qi(n)&&n.Jr.set("Unknown"))}function Mi(t,e){t.Yr.X(e.targetId),no(t).Pr(e)}function Pi(t,e){t.Yr.X(e),no(t).vr(e)}function Oi(t){t.Yr=new gn({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Et:e=>t.Wr.get(e)||null}),no(t).start(),t.Jr.Br()}function Vi(t){return qi(t)&&!no(t).hr()&&t.Wr.size>0}function qi(t){return 0===E(t).Gr.size}function Ui(t){t.Yr=void 0}async function Bi(t){t.Wr.forEach(((e,n)=>{Mi(t,e)}))}async function Ki(t,e){Ui(t),Vi(t)?(t.Jr.Kr(e),Oi(t)):t.Jr.set("Unknown")}async function $i(t,e,n){if(t.Jr.set("Online"),e instanceof fn&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.Wr.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.Wr.delete(r),t.Yr.removeTarget(r))}(t,e)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await ji(t,n)}else if(e instanceof ln?t.Yr.ot(e):e instanceof dn?t.Yr.dt(e):t.Yr.ut(e),!n.isEqual(K.min()))try{const e=await Bs(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.Yr.gt(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.Wr.get(r);s&&t.Wr.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.Wr.get(e);if(!n)return;t.Wr.set(e,n.withResumeToken(X.EMPTY_BYTE_STRING,n.snapshotVersion)),Pi(t,e);const r=new Fr(n.target,e,1,n.sequenceNumber);Mi(t,r)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){g("RemoteStore","Failed to raise snapshot:",e),await ji(t,e)}}async function ji(t,e,n){if(!_r(e))throw e;t.Gr.add(1),await Ri(t),t.Jr.set("Offline"),n||(n=()=>Bs(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),t.Gr.delete(1),await xi(t)}))}function Gi(t,e){return e().catch((n=>ji(t,n,e)))}async function zi(t){const e=E(t),n=ro(e);let r=e.Qr.length>0?e.Qr[e.Qr.length-1].batchId:-1;for(;Qi(e);)try{const t=await $s(e.localStore,r);if(null===t){0===e.Qr.length&&n._r();break}r=t.batchId,Wi(e,t)}catch(t){await ji(e,t)}Hi(e)&&Yi(e)}function Qi(t){return qi(t)&&t.Qr.length<10}function Wi(t,e){t.Qr.push(e);const n=ro(t);n.lr()&&n.Sr&&n.Dr(e.mutations)}function Hi(t){return qi(t)&&!ro(t).hr()&&t.Qr.length>0}function Yi(t){ro(t).start()}async function Ji(t){ro(t).kr()}async function Xi(t){const e=ro(t);for(const n of t.Qr)e.Dr(n.mutations)}async function Zi(t,e,n){const r=t.Qr.shift(),s=Lr.from(r,e,n);await Gi(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await zi(t)}async function to(t,e){e&&ro(t).Sr&&await async function(t,e){if(Ge(n=e.code)&&n!==b.ABORTED){const n=t.Qr.shift();ro(t).wr(),await Gi(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await zi(t)}var n}(t,e),Hi(t)&&Yi(t)}async function eo(t,e){const n=E(t);e?(n.Gr.delete(2),await xi(n)):e||(n.Gr.add(2),await Ri(n),n.Jr.set("Unknown"))}function no(t){return t.Xr||(t.Xr=function(t,e,n){const r=E(t);return r.Or(),new ki(e,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(t.datastore,t.asyncQueue,{Di:Bi.bind(null,t),Ni:Ki.bind(null,t),br:$i.bind(null,t)}),t.zr.push((async e=>{e?(t.Xr.wr(),Vi(t)?Oi(t):t.Jr.set("Unknown")):(await t.Xr.stop(),Ui(t))}))),t.Xr}function ro(t){return t.Zr||(t.Zr=function(t,e,n){const r=E(t);return r.Or(),new Ai(e,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(t.datastore,t.asyncQueue,{Di:Ji.bind(null,t),Ni:to.bind(null,t),Nr:Xi.bind(null,t),Cr:Zi.bind(null,t)}),t.zr.push((async e=>{e?(t.Zr.wr(),await zi(t)):(await t.Zr.stop(),t.Qr.length>0&&(g("RemoteStore",`Stopping write stream with ${t.Qr.length} pending writes`),t.Qr=[]))}))),t.Zr}class so{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new _,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new so(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(b.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function io(t,e){if(p("AsyncQueue",`${e}: ${t}`),_r(t))return new S(b.UNAVAILABLE,`${e}: ${t}`);throw t}class oo{constructor(t){this.comparator=t?(e,n)=>t(e,n)||ut.comparator(e.key,n.key):(t,e)=>ut.comparator(t.key,e.key),this.keyedMap=en(),this.sortedSet=new Qe(this.comparator)}static emptySet(t){return new oo(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof oo))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new oo;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class ao{constructor(){this.eo=new Qe(ut.comparator)}track(t){const e=t.doc.key,n=this.eo.get(e);n?0!==t.type&&3===n.type?this.eo=this.eo.insert(e,t):3===t.type&&1!==n.type?this.eo=this.eo.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.eo=this.eo.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.eo=this.eo.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.eo=this.eo.remove(e):1===t.type&&2===n.type?this.eo=this.eo.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.eo=this.eo.insert(e,{type:2,doc:t.doc}):v():this.eo=this.eo.insert(e,t)}no(){const t=[];return this.eo.inorderTraversal(((e,n)=>{t.push(n)})),t}}class co{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach((t=>{s.push({type:0,doc:t})})),new co(t,e,oo.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&se(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0}}class uo{constructor(){this.so=void 0,this.listeners=[]}}class ho{constructor(){this.queries=new Is((t=>ie(t)),se),this.onlineState="Unknown",this.io=new Set}}async function lo(t,e){const n=E(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new uo),s)try{i.so=await n.onListen(r)}catch(t){const n=io(t,`Initialization of query '${oe(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.ro(n.onlineState),i.so&&e.oo(i.so)&&po(n)}async function fo(t,e){const n=E(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function mo(t,e){const n=E(t);let r=!1;for(const s of e){const t=s.query,e=n.queries.get(t);if(e){for(const t of e.listeners)t.oo(s)&&(r=!0);e.so=s}}r&&po(n)}function go(t,e,n){const r=E(t),s=r.queries.get(e);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(e)}function po(t){t.io.forEach((t=>{t.next()}))}class yo{constructor(t,e,n){this.query=t,this.ao=e,this.co=!1,this.uo=null,this.onlineState="Unknown",this.options=n||{}}oo(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new co(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.co?this.ho(t)&&(this.ao.next(t),e=!0):this.lo(t,this.onlineState)&&(this.fo(t),e=!0),this.uo=t,e}onError(t){this.ao.error(t)}ro(t){this.onlineState=t;let e=!1;return this.uo&&!this.co&&this.lo(this.uo,t)&&(this.fo(this.uo),e=!0),e}lo(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.wo||!n)&&(!t.docs.isEmpty()||"Offline"===e)}ho(t){if(t.docChanges.length>0)return!0;const e=this.uo&&this.uo.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}fo(t){t=co.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.co=!0,this.ao.next(t)}}class wo{constructor(t,e){this.payload=t,this.byteLength=e}_o(){return"metadata"in this.payload}}class vo{constructor(t){this.k=t}Hn(t){return Nn(this.k,t)}Jn(t){return t.metadata.exists?Fn(this.k,t.document,!1):kt.newNoDocument(this.Hn(t.metadata.name),this.Yn(t.metadata.readTime))}Yn(t){return Sn(t)}}class Io{constructor(t,e,n){this.mo=t,this.localStore=e,this.k=n,this.queries=[],this.documents=[],this.progress=To(t)}yo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}po(t){const e=new Map,n=new vo(this.k);for(const r of t)if(r.metadata.queries){const t=n.Hn(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||on()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=E(t);let i=on(),o=Ze(),a=rn();for(const h of n){const t=e.Hn(h.metadata.name);h.document&&(i=i.add(t)),o=o.insert(t,e.Jn(h)),a=a.insert(t,e.Yn(h.metadata.readTime))}const c=s.Qn.newChangeBuffer({trackRemovals:!0}),u=await js(s,function(t){return ne(Ht(Q.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Ks(t,c,o,K.min(),a).next((e=>(c.apply(t),e))).next((e=>s.He.removeMatchingKeysForTargetId(t,u.targetId).next((()=>s.He.addMatchingKeys(t,i,u.targetId))).next((()=>s.Wn.Vn(t,e))).next((()=>e))))))}(this.localStore,new vo(this.k),this.documents,this.mo.id),e=this.po(this.documents);for(const n of this.queries)await Hs(this.localStore,n,e.get(n.name));return this.progress.taskState="Success",new Fs(Object.assign({},this.progress),t)}}function To(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Eo{constructor(t){this.key=t}}class bo{constructor(t){this.key=t}}class So{constructor(t,e){this.query=t,this.To=e,this.Eo=null,this.current=!1,this.Io=on(),this.mutatedKeys=on(),this.Ao=ce(t),this.Ro=new oo(this.Ao)}get bo(){return this.To}Po(t,e){const n=e?e.vo:new ao,r=e?e.Ro:this.Ro;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a=Yt(this.query)&&r.size===this.query.limit?r.last():null,c=Jt(this.query)&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const u=r.get(t),h=ae(this.query,e)?e:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Vo(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Ao(h,a)>0||c&&this.Ao(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),Yt(this.query)||Jt(this.query))for(;i.size>this.query.limit;){const t=Yt(this.query)?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{Ro:i,vo:n,Bn:o,mutatedKeys:s}}Vo(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const r=this.Ro;this.Ro=t.Ro,this.mutatedKeys=t.mutatedKeys;const s=t.vo.no();s.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(t)-n(e)}(t.type,e.type)||this.Ao(t.doc,e.doc))),this.So(n);const i=e?this.Do():[],o=0===this.Io.size&&this.current?1:0,a=o!==this.Eo;return this.Eo=o,0!==s.length||a?{snapshot:new co(this.query,t.Ro,r,s,t.mutatedKeys,0===o,a,!1),Co:i}:{Co:i}}ro(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Ro:this.Ro,vo:new ao,mutatedKeys:this.mutatedKeys,Bn:!1},!1)):{Co:[]}}No(t){return!this.To.has(t)&&!!this.Ro.has(t)&&!this.Ro.get(t).hasLocalMutations}So(t){t&&(t.addedDocuments.forEach((t=>this.To=this.To.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.To=this.To.delete(t))),this.current=t.current)}Do(){if(!this.current)return[];const t=this.Io;this.Io=on(),this.Ro.forEach((t=>{this.No(t.key)&&(this.Io=this.Io.add(t.key))}));const e=[];return t.forEach((t=>{this.Io.has(t)||e.push(new bo(t))})),this.Io.forEach((n=>{t.has(n)||e.push(new Eo(n))})),e}ko(t){this.To=t.zn,this.Io=on();const e=this.Po(t.documents);return this.applyChanges(e,!0)}xo(){return co.fromInitialDocuments(this.query,this.Ro,this.mutatedKeys,0===this.Eo)}}class _o{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class ko{constructor(t){this.key=t,this.$o=!1}}class Ao{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Oo={},this.Fo=new Is((t=>ie(t)),se),this.Mo=new Map,this.Lo=new Set,this.Bo=new Qe(ut.comparator),this.Uo=new Map,this.qo=new Js,this.Ko={},this.jo=new Map,this.Qo=cs.re(),this.onlineState="Unknown",this.Wo=void 0}get isPrimaryClient(){return!0===this.Wo}}async function No(t,e){const n=ta(t);let r,s;const i=n.Fo.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.xo();else{const t=await js(n.localStore,ne(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await Do(n,e,r,"current"===i),n.isPrimaryClient&&Li(n.remoteStore,t)}return s}async function Do(t,e,n,r){t.Go=(e,n,r)=>async function(t,e,n,r){let s=e.view.Po(n);s.Bn&&(s=await zs(t.localStore,e.query,!1).then((({documents:t})=>e.view.Po(t,s))));const i=r&&r.targetChanges.get(e.targetId),o=e.view.applyChanges(s,t.isPrimaryClient,i);return Uo(t,e.targetId,o.Co),o.snapshot}(t,e,n,r);const s=await zs(t.localStore,e,!0),i=new So(e,s.zn),o=i.Po(s.documents),a=hn.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState),c=i.applyChanges(o,t.isPrimaryClient,a);Uo(t,n,c.Co);const u=new _o(e,n,i);return t.Fo.set(e,u),t.Mo.has(n)?t.Mo.get(n).push(e):t.Mo.set(n,[e]),c.snapshot}async function Co(t,e){const n=E(t),r=n.Fo.get(e),s=n.Mo.get(r.targetId);if(s.length>1)return n.Mo.set(r.targetId,s.filter((t=>!se(t,e)))),void n.Fo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Gs(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Fi(n.remoteStore,r.targetId),Vo(n,r.targetId)})).catch(fs)):(Vo(n,r.targetId),await Gs(n.localStore,r.targetId,!0))}async function xo(t,e){const n=E(t);try{const t=await function(t,e){const n=E(t),r=e.snapshotVersion;let s=n.qn;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Qn.newChangeBuffer({trackRemovals:!0});s=n.qn;const o=[];e.targetChanges.forEach(((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.He.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.He.addMatchingKeys(t,i.addedDocuments,a))));let u=c.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?u=u.withResumeToken(X.EMPTY_BYTE_STRING,K.min()).withLastLimboFreeSnapshotVersion(K.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.He.updateTargetData(t,u))}));let a=Ze();if(e.documentUpdates.forEach(((r,s)=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(Ks(t,i,e.documentUpdates,r,void 0).next((t=>{a=t}))),!r.isEqual(K.min())){const e=n.He.getLastRemoteSnapshotVersion(t).next((e=>n.He.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return Ir.waitFor(o).next((()=>i.apply(t))).next((()=>n.Wn.Vn(t,a))).next((()=>a))})).then((t=>(n.qn=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Uo.get(e);r&&(I(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.$o=!0:t.modifiedDocuments.size>0?I(r.$o):t.removedDocuments.size>0&&(I(r.$o),r.$o=!1))})),await $o(n,t,e)}catch(t){await fs(t)}}function Ro(t,e,n){const r=E(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.Fo.forEach(((n,r)=>{const s=r.view.ro(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=E(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const s of n.listeners)s.ro(e)&&(r=!0)})),r&&po(n)}(r.eventManager,e),t.length&&r.Oo.br(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function Lo(t,e,n){const r=E(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Uo.get(e),i=s&&s.key;if(i){let t=new Qe(ut.comparator);t=t.insert(i,kt.newNoDocument(i,K.min()));const n=on().add(i),s=new un(K.min(),new Map,new Ye(V),t,n);await xo(r,s),r.Bo=r.Bo.remove(i),r.Uo.delete(e),Ko(r)}else await Gs(r.localStore,e,!1).then((()=>Vo(r,e,n))).catch(fs)}async function Fo(t,e){const n=E(t),r=e.batch.batchId;try{const t=await function(t,e){const n=E(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.Qn.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=Ir.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);I(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&r.addEntry(e,n.commitVersion))}))})),o.next((()=>t.An.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.An.performConsistencyCheck(t))).next((()=>n.Wn.vn(t,r)))}))}(n.localStore,e);Oo(n,r,null),Po(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await $o(n,t)}catch(t){await fs(t)}}async function Mo(t,e,n){const r=E(t);try{const t=await function(t,e){const n=E(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.An.lookupMutationBatch(t,e).next((e=>(I(null!==e),r=e.keys(),n.An.removeMutationBatch(t,e)))).next((()=>n.An.performConsistencyCheck(t))).next((()=>n.Wn.vn(t,r)))}))}(r.localStore,e);Oo(r,e,n),Po(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await $o(r,t)}catch(n){await fs(n)}}function Po(t,e){(t.jo.get(e)||[]).forEach((t=>{t.resolve()})),t.jo.delete(e)}function Oo(t,e,n){const r=E(t);let s=r.Ko[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Ko[r.currentUser.toKey()]=s}}function Vo(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.Mo.get(e))t.Fo.delete(r),n&&t.Oo.zo(r,n);t.Mo.delete(e),t.isPrimaryClient&&t.qo.us(e).forEach((e=>{t.qo.containsKey(e)||qo(t,e)}))}function qo(t,e){t.Lo.delete(e.path.canonicalString());const n=t.Bo.get(e);null!==n&&(Fi(t.remoteStore,n),t.Bo=t.Bo.remove(e),t.Uo.delete(n),Ko(t))}function Uo(t,e,n){for(const r of n)r instanceof Eo?(t.qo.addReference(r.key,e),Bo(t,r)):r instanceof bo?(g("SyncEngine","Document no longer in limbo: "+r.key),t.qo.removeReference(r.key,e),t.qo.containsKey(r.key)||qo(t,r.key)):v()}function Bo(t,e){const n=e.key,r=n.path.canonicalString();t.Bo.get(n)||t.Lo.has(r)||(g("SyncEngine","New document in limbo: "+n),t.Lo.add(r),Ko(t))}function Ko(t){for(;t.Lo.size>0&&t.Bo.size<t.maxConcurrentLimboResolutions;){const e=t.Lo.values().next().value;t.Lo.delete(e);const n=new ut(Q.fromString(e)),r=t.Qo.next();t.Uo.set(r,new ko(n)),t.Bo=t.Bo.insert(n,r),Li(t.remoteStore,new Fr(ne(Ht(n.path)),r,2,M.I))}}async function $o(t,e,n){const r=E(t),s=[],i=[],o=[];r.Fo.isEmpty()||(r.Fo.forEach(((t,a)=>{o.push(r.Go(a,e,n).then((t=>{if(t){r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),s.push(t);const e=Ps.$n(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.Oo.br(s),await async function(t,e){const n=E(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>Ir.forEach(e,(e=>Ir.forEach(e.kn,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>Ir.forEach(e.xn,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!_r(t))throw t;g("LocalStore","Failed to update sequence numbers: "+t)}for(const r of e){const t=r.targetId;if(!r.fromCache){const e=n.qn.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.qn=n.qn.insert(t,s)}}}(r.localStore,i))}async function jo(t,e){const n=E(t);if(!n.currentUser.isEqual(e)){g("SyncEngine","User change. New user:",e.toKey());const t=await Us(n.localStore,e);n.currentUser=e,function(t,e){t.jo.forEach((t=>{t.forEach((t=>{t.reject(new S(b.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.jo.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await $o(n,t.Gn)}}function Go(t,e){const n=E(t),r=n.Uo.get(e);if(r&&r.$o)return on().add(r.key);{let t=on();const r=n.Mo.get(e);if(!r)return t;for(const e of r){const r=n.Fo.get(e);t=t.unionWith(r.view.bo)}return t}}async function zo(t,e){const n=E(t),r=await zs(n.localStore,e.query,!0),s=e.view.ko(r);return n.isPrimaryClient&&Uo(n,e.targetId,s.Co),s}async function Qo(t){const e=E(t);return Ws(e.localStore).then((t=>$o(e,t)))}async function Wo(t,e,n,r){const s=E(t),i=await function(t,e){const n=E(t),r=E(n.An);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.Zt(t,e).next((e=>e?n.Wn.vn(t,e):Ir.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await zi(s.remoteStore):"acknowledged"===n||"rejected"===n?(Oo(s,e,r||null),Po(s,e),function(t,e){E(E(t).An).ee(e)}(s.localStore,e)):v(),await $o(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Ho(t,e,n){const r=E(t),s=[],i=[];for(const o of e){let t;const e=r.Mo.get(o);if(e&&0!==e.length){t=await js(r.localStore,ne(e[0]));for(const t of e){const e=r.Fo.get(t),n=await zo(r,e);n.snapshot&&i.push(n.snapshot)}}else{const e=await Qs(r.localStore,o);t=await js(r.localStore,e),await Do(r,Yo(e),o,!1)}s.push(t)}return r.Oo.br(i),s}function Yo(t){return Wt(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Jo(t){const e=E(t);return E(E(e.localStore).persistence).Tn()}async function Xo(t,e,n,r){const s=E(t);if(s.Wo)g("SyncEngine","Ignoring unexpected query state notification.");else if(s.Mo.has(e))switch(n){case"current":case"not-current":{const t=await Ws(s.localStore),r=un.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await $o(s,t,r);break}case"rejected":await Gs(s.localStore,e,!0),Vo(s,e,r);break;default:v()}}async function Zo(t,e,n){const r=ta(t);if(r.Wo){for(const t of e){if(r.Mo.has(t)){g("SyncEngine","Adding an already active target "+t);continue}const e=await Qs(r.localStore,t),n=await js(r.localStore,e);await Do(r,Yo(e),n.targetId,!1),Li(r.remoteStore,n)}for(const t of n)r.Mo.has(t)&&await Gs(r.localStore,t,!1).then((()=>{Fi(r.remoteStore,t),Vo(r,t)})).catch(fs)}}function ta(t){const e=E(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=xo.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Go.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Lo.bind(null,e),e.Oo.br=mo.bind(null,e.eventManager),e.Oo.zo=go.bind(null,e.eventManager),e}function ea(t){const e=E(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Fo.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Mo.bind(null,e),e}class na{constructor(){this.synchronizeTabs=!1}async initialize(t){this.k=bi(t.databaseInfo.databaseId),this.sharedClientState=this.Jo(t),this.persistence=this.Yo(t),await this.persistence.start(),this.gcScheduler=this.Xo(t),this.localStore=this.Zo(t)}Xo(t){return null}Zo(t){return qs(this.persistence,new Os,t.initialUser,this.k)}Yo(t){return new ri(ii.ks,this.k)}Jo(t){return new gi}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ra extends na{constructor(t,e,n){super(),this.ta=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=E(t);return e.persistence.runTransaction("Synchronize last document change read time","readonly",(t=>function(t){const e=_s(t);let n=K.min();return e.jt({index:cr.readTimeIndex,reverse:!0},((t,e,r)=>{e.readTime&&(n=qr(e.readTime)),r.done()})).next((()=>n))}(t))).then((t=>{e.jn=t}))}(this.localStore),await this.ta.initialize(this,t),await ea(this.ta.syncEngine),await zi(this.ta.remoteStore),await this.persistence.sn((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Zo(t){return qs(this.persistence,new Os,t.initialUser,this.k)}Xo(t){const e=this.persistence.referenceDelegate.garbageCollector;return new ps(e,t.asyncQueue)}Yo(t){const e=Ls(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ts.withCacheSize(this.cacheSizeBytes):ts.DEFAULT;return new Cs(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Ti(),Ei(),this.k,this.sharedClientState,!!this.forceOwnership)}Jo(t){return new gi}}class sa extends ra{constructor(t,e){super(t,e,!1),this.ta=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.ta.syncEngine;this.sharedClientState instanceof mi&&(this.sharedClientState.syncEngine={mi:Wo.bind(null,e),gi:Xo.bind(null,e),yi:Zo.bind(null,e),Tn:Jo.bind(null,e),_i:Qo.bind(null,e)},await this.sharedClientState.start()),await this.persistence.sn((async t=>{await async function(t,e){const n=E(t);if(ta(n),ea(n),!0===e&&!0!==n.Wo){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Ho(n,t.toArray());n.Wo=!0,await eo(n.remoteStore,!0);for(const r of e)Li(n.remoteStore,r)}else if(!1===e&&!1!==n.Wo){const t=[];let e=Promise.resolve();n.Mo.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(Vo(n,s),Gs(n.localStore,s,!0)))),Fi(n.remoteStore,s)})),await e,await Ho(n,t),function(t){const e=E(t);e.Uo.forEach(((t,n)=>{Fi(e.remoteStore,n)})),e.qo.hs(),e.Uo=new Map,e.Bo=new Qe(ut.comparator)}(n),n.Wo=!1,await eo(n.remoteStore,!1)}}(this.ta.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())}))}Jo(t){const e=Ti();if(!mi.Pt(e))throw new S(b.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Ls(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new mi(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class ia{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Ro(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=jo.bind(null,this.syncEngine),await eo(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new ho}createDatastore(t){const e=bi(t.databaseInfo.databaseId),n=(r=t.databaseInfo,new Ii(r));var r;return function(t,e,n,r){return new Ni(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>Ro(this.syncEngine,t,0),i=yi.Pt()?new yi:new pi,new Ci(e,n,r,s,i);var e,n,r,s,i}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new Ao(t,e,n,r,s,i);return o&&(a.Wo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=E(t);g("RemoteStore","RemoteStore shutting down."),e.Gr.add(5),await Ri(e),e.Hr.shutdown(),e.Jr.set("Unknown")}(this.remoteStore)}}function oa(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class aa{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.ea(this.observer.next,t)}error(t){this.observer.error?this.ea(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}na(){this.muted=!0}ea(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class ca{constructor(t,e){this.sa=t,this.k=e,this.metadata=new _,this.buffer=new Uint8Array,this.ia=new TextDecoder("utf-8"),this.ra().then((t=>{t&&t._o()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.sa.cancel()}async getMetadata(){return this.metadata.promise}async Ho(){return await this.getMetadata(),this.ra()}async ra(){const t=await this.oa();if(null===t)return null;const e=this.ia.decode(t),n=Number(e);isNaN(n)&&this.aa(`length string (${e}) is not valid number`);const r=await this.ca(n);return new wo(JSON.parse(r),t.length+n)}ua(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async oa(){for(;this.ua()<0&&!(await this.ha()););if(0===this.buffer.length)return null;const t=this.ua();t<0&&this.aa("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async ca(t){for(;this.buffer.length<t;)await this.ha()&&this.aa("Reached the end of bundle when more is expected.");const e=this.ia.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}aa(t){throw this.sa.cancel(),new Error(`Invalid bundle format: ${t}`)}async ha(){const t=await this.sa.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class ua{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(b.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=E(t),r=xn(n.k)+"/documents",s={documents:e.map((t=>An(n.k,t)))},i=await n.ji("BatchGetDocuments",r,s),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){I(!!e.found),e.found.name,e.found.updateTime;const n=Nn(t,e.found.name),r=Sn(e.found.updateTime),s=new St({mapValue:{fields:e.found.fields}});return kt.newFoundDocument(n,r,s)}(t,e):"missing"in e?function(t,e){I(!!e.missing),I(!!e.readTime);const n=Nn(t,e.missing),r=Sn(e.readTime);return kt.newNoDocument(n,r)}(t,e):v()}(n.k,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());I(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Ue(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=ut.fromPath(e);this.mutations.push(new Be(n,this.precondition(n)))})),await async function(t,e){const n=E(t),r=xn(n.k)+"/documents",s={writes:e.map((t=>Mn(n.k,t)))};await n.Bi("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw v();e=K.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new S(b.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?Ae.updateTime(e):Ae.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(K.min()))throw new S(b.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Ae.updateTime(e)}return Ae.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class ha{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.la=5,this.ur=new Si(this.asyncQueue,"transaction_retry")}run(){this.la-=1,this.fa()}fa(){this.ur.Zi((async()=>{const t=new ua(this.datastore),e=this.da(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.wa(t)}))))})).catch((t=>{this.wa(t)}))}))}da(t){try{const e=this.updateFunction(t);return!ot(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}wa(t){this.la>0&&this._a(t)?(this.la-=1,this.asyncQueue.enqueueAndForget((()=>(this.fa(),Promise.resolve())))):this.deferred.reject(t)}_a(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!Ge(e)}return!1}}class la{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=h.UNAUTHENTICATED,this.clientId=O.A(),this.authCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{g("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(()=>Promise.resolve()))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new _;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=io(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function da(t,e){t.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await Us(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function fa(t,e){t.asyncQueue.verifyOperationInProgress();const n=await ma(t);g("FirestoreClient","Initializing OnlineComponentProvider");const r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener((t=>async function(t,e){const n=E(t);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=qi(n);n.Gr.add(3),await Ri(n),r&&n.Jr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Gr.delete(3),await xi(n)}(e.remoteStore,t))),t.onlineComponents=e}async function ma(t){return t.offlineComponents||(g("FirestoreClient","Using default OfflineComponentProvider"),await da(t,new na)),t.offlineComponents}async function ga(t){return t.onlineComponents||(g("FirestoreClient","Using default OnlineComponentProvider"),await fa(t,new ia)),t.onlineComponents}function pa(t){return ma(t).then((t=>t.persistence))}function ya(t){return ma(t).then((t=>t.localStore))}function wa(t){return ga(t).then((t=>t.remoteStore))}function va(t){return ga(t).then((t=>t.syncEngine))}async function Ia(t){const e=await ga(t),n=e.eventManager;return n.onListen=No.bind(null,e.syncEngine),n.onUnlisten=Co.bind(null,e.syncEngine),n}function Ta(t,e,n={}){const r=new _;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new aa({next:i=>{e.enqueueAndForget((()=>fo(t,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new S(b.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new S(b.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new yo(Ht(n.path),i,{includeMetadataChanges:!0,wo:!0});return lo(t,o)}(await Ia(t),t.asyncQueue,e,n,r))),r.promise}function Ea(t,e,n={}){const r=new _;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new aa({next:n=>{e.enqueueAndForget((()=>fo(t,o))),n.fromCache&&"server"===r.source?s.reject(new S(b.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new yo(n,i,{includeMetadataChanges:!0,wo:!0});return lo(t,o)}(await Ia(t),t.asyncQueue,e,n,r))),r.promise}function ba(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new ca(t,e)}(function(t,e){if(t instanceof Uint8Array)return oa(t,e);if(t instanceof ArrayBuffer)return oa(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,bi(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=E(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=E(t),r=Sn(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ye.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),void n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r));n._updateProgress(To(r));const s=new Io(r,t.localStore,e.k);let i=await e.Ho();for(;i;){const t=await s.yo(i);t&&n._updateProgress(t),i=await e.Ho()}const o=await s.complete();await $o(t,o.In,void 0),await function(t,e){const n=E(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ye.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress)}catch(t){y("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t)}})(r,e,n).then((()=>{r.sharedClientState.notifyBundleLoaded()}))}(await va(t),s,r)}))}class Sa{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class _a{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof _a&&t.projectId===this.projectId&&t.database===this.database}}const ka=new Map;function Aa(t,e,n){if(!n)throw new S(b.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Na(t,e,n,r){if(!0===e&&!0===r)throw new S(b.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Da(t){if(!ut.isDocumentKey(t))throw new S(b.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Ca(t){if(ut.isDocumentKey(t))throw new S(b.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function xa(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":v()}function Ra(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new S(b.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=xa(t);throw new S(b.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function La(t,e){if(e<=0)throw new S(b.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Fa{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new S(b.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new S(b.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Na("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Ma{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Fa({}),this._settingsFrozen=!1,t instanceof _a?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new S(b.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new _a(t.options.projectId)}(t))}get app(){if(!this._app)throw new S(b.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Fa(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new A;switch(t.type){case"gapi":const e=t.client;return I(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new x(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new S(b.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=ka.get(t);e&&(g("ComponentProvider","Removing Datastore"),ka.delete(t),e.terminate())}(this),Promise.resolve()}}function Pa(t,e,n,r={}){var s;const i=(t=Ra(t,Ma))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=h.MOCK_USER;else{e=(0,o.Sg)(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(b.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new h(i)}t._authCredentials=new N(new k(e,n))}}class Oa{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new qa(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Oa(this.firestore,t,this._key)}}class Va{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Va(this.firestore,t,this._query)}}class qa extends Va{constructor(t,e,n){super(t,e,Ht(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Oa(this.firestore,null,new ut(t))}withConverter(t){return new qa(this.firestore,t,this._path)}}function Ua(t,e,...n){if(t=(0,o.m9)(t),Aa("collection","path",e),t instanceof Ma){const r=Q.fromString(e,...n);return Ca(r),new qa(t,null,r)}{if(!(t instanceof Oa||t instanceof qa))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(Q.fromString(e,...n));return Ca(r),new qa(t.firestore,null,r)}}function Ba(t,e){if(t=Ra(t,Ma),Aa("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Va(t,null,function(t){return new Qt(Q.emptyPath(),t)}(e))}function Ka(t,e,...n){if(t=(0,o.m9)(t),1===arguments.length&&(e=O.A()),Aa("doc","path",e),t instanceof Ma){const r=Q.fromString(e,...n);return Da(r),new Oa(t,null,new ut(r))}{if(!(t instanceof Oa||t instanceof qa))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(Q.fromString(e,...n));return Da(r),new Oa(t.firestore,t instanceof qa?t.converter:null,new ut(r))}}function $a(t,e){return t=(0,o.m9)(t),e=(0,o.m9)(e),(t instanceof Oa||t instanceof qa)&&(e instanceof Oa||e instanceof qa)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function ja(t,e){return t=(0,o.m9)(t),e=(0,o.m9)(e),t instanceof Va&&e instanceof Va&&t.firestore===e.firestore&&se(t._query,e._query)&&t.converter===e.converter}class Ga{constructor(){this.ma=Promise.resolve(),this.ga=[],this.ya=!1,this.pa=[],this.Ta=null,this.Ea=!1,this.Ia=!1,this.Aa=[],this.ur=new Si(this,"async_queue_retry"),this.Ra=()=>{const t=Ei();t&&g("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ur.er()};const t=Ei();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Ra)}get isShuttingDown(){return this.ya}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.ba(),this.Pa(t)}enterRestrictedMode(t){if(!this.ya){this.ya=!0,this.Ia=t||!1;const e=Ei();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Ra)}}enqueue(t){if(this.ba(),this.ya)return new Promise((()=>{}));const e=new _;return this.Pa((()=>this.ya&&this.Ia?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.ga.push(t),this.va())))}async va(){if(0!==this.ga.length){try{await this.ga[0](),this.ga.shift(),this.ur.reset()}catch(t){if(!_r(t))throw t;g("AsyncQueue","Operation failed with retryable error: "+t)}this.ga.length>0&&this.ur.Zi((()=>this.va()))}}Pa(t){const e=this.ma.then((()=>(this.Ea=!0,t().catch((t=>{this.Ta=t,this.Ea=!1;throw p("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t})).then((t=>(this.Ea=!1,t))))));return this.ma=e,e}enqueueAfterDelay(t,e,n){this.ba(),this.Aa.indexOf(t)>-1&&(e=0);const r=so.createAndSchedule(this,t,e,n,(t=>this.Va(t)));return this.pa.push(r),r}ba(){this.Ta&&v()}verifyOperationInProgress(){}async Sa(){let t;do{t=this.ma,await t}while(t!==this.ma)}Da(t){for(const e of this.pa)if(e.timerId===t)return!0;return!1}Ca(t){return this.Sa().then((()=>{this.pa.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.pa)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Sa()}))}Na(t){this.Aa.push(t)}Va(t){const e=this.pa.indexOf(t);this.pa.splice(e,1)}}function za(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(t)}class Qa{constructor(){this._progressObserver={},this._taskCompletionResolver=new _,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const Wa=-1;class Ha extends Ma{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new Ga,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Za(this),this._firestoreClient.terminate()}}function Ya(t,e){const n=(0,r.qX)(t,"firestore");if(n.isInitialized()){const t=n.getImmediate(),r=n.getOptions();if((0,o.vZ)(r,e))return t;throw new S(b.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new S(b.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function Ja(t=(0,r.Mq)()){return(0,r.qX)(t,"firestore").getImmediate()}function Xa(t){return t._firestoreClient||Za(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Za(t){var e;const n=t._freezeSettings(),r=function(t,e,n,r){return new Sa(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new la(t._authCredentials,t._appCheckCredentials,t._queue,r)}function tc(t,e){hc(t=Ra(t,Ha));const n=Xa(t),r=t._freezeSettings(),s=new ia;return nc(n,s,new ra(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function ec(t){hc(t=Ra(t,Ha));const e=Xa(t),n=t._freezeSettings(),r=new ia;return nc(e,r,new sa(r,n.cacheSizeBytes))}function nc(t,e,n){const r=new _;return t.asyncQueue.enqueue((async()=>{try{await da(t,n),await fa(t,e),r.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===b.FAILED_PRECONDITION||t.code===b.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.reject(t)}})).then((()=>r.promise))}function rc(t){if(t._initialized&&!t._terminated)throw new S(b.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new _;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Er.Pt())return Promise.resolve();const e=t+"main";await Er.delete(e)}(Ls(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function sc(t){return function(t){const e=new _;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=E(t);qi(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=E(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.An.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.jo.get(t)||[];r.push(e),n.jo.set(t,r)}catch(t){const n=io(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await va(t),e))),e.promise}(Xa(t=Ra(t,Ha)))}function ic(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await pa(t),n=await wa(t);return e.setNetworkEnabled(!0),function(t){const e=E(t);return e.Gr.delete(0),xi(e)}(n)}))}(Xa(t=Ra(t,Ha)))}function oc(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await pa(t),n=await wa(t);return e.setNetworkEnabled(!1),async function(t){const e=E(t);e.Gr.add(0),await Ri(e),e.Jr.set("Offline")}(n)}))}(Xa(t=Ra(t,Ha)))}function ac(t){return(0,r.wN)(t.app,"firestore"),t._delete()}function cc(t,e){const n=Xa(t=Ra(t,Ha)),r=new Qa;return ba(n,t._databaseId,e,r),r}function uc(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=E(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ye.getNamedQuery(t,e)))}(await ya(t),e)))}(Xa(t=Ra(t,Ha)),e).then((e=>e?new Va(t,null,e.query):null))}function hc(t){if(t._initialized||t._terminated)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class lc{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new S(b.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new H(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function dc(){return new lc("__name__")}class fc{constructor(t){this._byteString=t}static fromBase64String(t){try{return new fc(X.fromBase64String(t))}catch(t){throw new S(b.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new fc(X.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class mc{constructor(t){this._methodName=t}}class gc{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new S(b.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new S(b.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return V(this._lat,t._lat)||V(this._long,t._long)}}const pc=/^__.*__$/;class yc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Pe(t,this.data,this.fieldMask,e,this.fieldTransforms):new Me(t,this.data,e,this.fieldTransforms)}}class wc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Pe(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function vc(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class Ic{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.k=n,this.ignoreUndefinedProperties=r,void 0===s&&this.ka(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get xa(){return this.settings.xa}$a(t){return new Ic(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.k,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Oa(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$a({path:n,Fa:!1});return r.Ma(t),r}La(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$a({path:n,Fa:!1});return r.ka(),r}Ba(t){return this.$a({path:void 0,Fa:!0})}Ua(t){return Uc(t,this.settings.methodName,this.settings.qa||!1,this.path,this.settings.Ka)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}ka(){if(this.path)for(let t=0;t<this.path.length;t++)this.Ma(this.path.get(t))}Ma(t){if(0===t.length)throw this.Ua("Document fields must not be empty");if(vc(this.xa)&&pc.test(t))throw this.Ua('Document fields cannot begin and end with "__"')}}class Tc{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.k=n||bi(t)}ja(t,e,n,r=!1){return new Ic({xa:t,methodName:e,Ka:n,path:H.emptyPath(),Fa:!1,qa:r},this.databaseId,this.k,this.ignoreUndefinedProperties)}}function Ec(t){const e=t._freezeSettings(),n=bi(t._databaseId);return new Tc(t._databaseId,!!e.ignoreUndefinedProperties,n)}function bc(t,e,n,r,s,i={}){const o=t.ja(i.merge||i.mergeFields?2:0,e,n,s);Pc("Data must be an object, but it was:",o,r);const a=Fc(r,o);let c,u;if(i.merge)c=new Y(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=Oc(e,r,n);if(!o.contains(s))throw new S(b.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Bc(t,s)||t.push(s)}c=new Y(t),u=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,u=o.fieldTransforms;return new yc(new St(a),c,u)}class Sc extends mc{_toFieldTransform(t){if(2!==t.xa)throw 1===t.xa?t.Ua(`${this._methodName}() can only appear at the top level of your update data`):t.Ua(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Sc}}function _c(t,e,n){return new Ic({xa:3,Ka:e.settings.Ka,methodName:t._methodName,Fa:n},e.databaseId,e.k,e.ignoreUndefinedProperties)}class kc extends mc{_toFieldTransform(t){return new _e(t.path,new ye)}isEqual(t){return t instanceof kc}}class Ac extends mc{constructor(t,e){super(t),this.Qa=e}_toFieldTransform(t){const e=_c(this,t,!0),n=this.Qa.map((t=>Lc(t,e))),r=new we(n);return new _e(t.path,r)}isEqual(t){return this===t}}class Nc extends mc{constructor(t,e){super(t),this.Qa=e}_toFieldTransform(t){const e=_c(this,t,!0),n=this.Qa.map((t=>Lc(t,e))),r=new Ie(n);return new _e(t.path,r)}isEqual(t){return this===t}}class Dc extends mc{constructor(t,e){super(t),this.Wa=e}_toFieldTransform(t){const e=new Ee(t.k,de(t.k,this.Wa));return new _e(t.path,e)}isEqual(t){return this===t}}function Cc(t,e,n,r){const s=t.ja(1,e,n);Pc("Data must be an object, but it was:",s,r);const i=[],a=St.empty();j(r,((t,r)=>{const c=qc(e,t,n);r=(0,o.m9)(r);const u=s.La(c);if(r instanceof Sc)i.push(c);else{const t=Lc(r,u);null!=t&&(i.push(c),a.set(c,t))}}));const c=new Y(i);return new wc(a,c,s.fieldTransforms)}function xc(t,e,n,r,s,i){const a=t.ja(1,e,n),c=[Oc(e,r,n)],u=[s];if(i.length%2!=0)throw new S(b.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)c.push(Oc(e,i[o])),u.push(i[o+1]);const h=[],l=St.empty();for(let f=c.length-1;f>=0;--f)if(!Bc(h,c[f])){const t=c[f];let e=u[f];e=(0,o.m9)(e);const n=a.La(t);if(e instanceof Sc)h.push(t);else{const r=Lc(e,n);null!=r&&(h.push(t),l.set(t,r))}}const d=new Y(h);return new wc(l,d,a.fieldTransforms)}function Rc(t,e,n,r=!1){return Lc(n,t.ja(r?4:3,e))}function Lc(t,e){if(Mc(t=(0,o.m9)(t)))return Pc("Unsupported field value:",e,t),Fc(t,e);if(t instanceof mc)return function(t,e){if(!vc(e.xa))throw e.Ua(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Ua(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Fa&&4!==e.xa)throw e.Ua("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=Lc(s,e.Ba(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,o.m9)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return de(e.k,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=B.fromDate(t);return{timestampValue:Tn(e.k,n)}}if(t instanceof B){const n=new B(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Tn(e.k,n)}}if(t instanceof gc)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof fc)return{bytesValue:En(e.k,t._byteString)};if(t instanceof Oa){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.Ua(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:_n(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Ua(`Unsupported field value: ${xa(t)}`)}(t,e)}function Fc(t,e){const n={};return G(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):j(t,((t,r)=>{const s=Lc(r,e.Oa(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function Mc(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof B||t instanceof gc||t instanceof fc||t instanceof Oa||t instanceof mc)}function Pc(t,e,n){if(!Mc(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=xa(n);throw"an object"===r?e.Ua(t+" a custom object"):e.Ua(t+" "+r)}}function Oc(t,e,n){if((e=(0,o.m9)(e))instanceof lc)return e._internalPath;if("string"==typeof e)return qc(t,e);throw Uc("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}const Vc=new RegExp("[~\\*/\\[\\]]");function qc(t,e,n){if(e.search(Vc)>=0)throw Uc(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new lc(...e.split("."))._internalPath}catch(r){throw Uc(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Uc(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new S(b.INVALID_ARGUMENT,a+t+c)}function Bc(t,e){return t.some((t=>t.isEqual(e)))}class Kc{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Oa(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new $c(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(jc("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class $c extends Kc{data(){return super.data()}}function jc(t,e){return"string"==typeof e?qc(t,e):e instanceof lc?e._internalPath:e._delegate._internalPath}class Gc{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class zc extends Kc{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Qc(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(jc("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Qc extends zc{data(t={}){return super.data(t)}}class Wc{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Gc(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Qc(this._firestore,this._userDataWriter,n.key,n,new Gc(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new S(b.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new Qc(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Gc(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new Qc(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Gc(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Hc(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Hc(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function Yc(t,e){return t instanceof zc&&e instanceof zc?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Wc&&e instanceof Wc&&t._firestore===e._firestore&&ja(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Jc(t){if(Jt(t)&&0===t.explicitOrderBy.length)throw new S(b.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Xc{}function Zc(t,...e){for(const n of e)t=n._apply(t);return t}class tu extends Xc{constructor(t,e,n){super(),this.Ga=t,this.za=e,this.Ha=n,this.type="where"}_apply(t){const e=Ec(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(b.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){gu(o,i);const e=[];for(const n of o)e.push(mu(r,t,n));a={arrayValue:{values:e}}}else a=mu(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||gu(o,i),a=Rc(n,"where",o,"in"===i||"not-in"===i);const c=Rt.create(s,i,a);return function(t,e){if(e.V()){const n=Zt(t);if(null!==n&&!n.isEqual(e.field))throw new S(b.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const r=Xt(t);null!==r&&pu(t,e.field,r)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,c),c}(t._query,0,e,t.firestore._databaseId,this.Ga,this.za,this.Ha);return new Va(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new Qt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function eu(t,e,n){const r=e,s=jc("where",t);return new tu(s,r,n)}class nu extends Xc{constructor(t,e){super(),this.Ga=t,this.Ja=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new $t(e,n);return function(t,e){if(null===Xt(t)){const n=Zt(t);null!==n&&pu(t,n,e.field)}}(t,r),r}(t._query,this.Ga,this.Ja);return new Va(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Qt(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function ru(t,e="asc"){const n=e,r=jc("orderBy",t);return new nu(r,n)}class su extends Xc{constructor(t,e,n){super(),this.type=t,this.Ya=e,this.Xa=n}_apply(t){return new Va(t.firestore,t.converter,re(t._query,this.Ya,this.Xa))}}function iu(t){return La("limit",t),new su("limit",t,"F")}function ou(t){return La("limitToLast",t),new su("limitToLast",t,"L")}class au extends Xc{constructor(t,e,n){super(),this.type=t,this.Za=e,this.tc=n}_apply(t){const e=fu(t,this.type,this.Za,this.tc);return new Va(t.firestore,t.converter,function(t,e){return new Qt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function cu(...t){return new au("startAt",t,!0)}function uu(...t){return new au("startAfter",t,!1)}class hu extends Xc{constructor(t,e,n){super(),this.type=t,this.Za=e,this.tc=n}_apply(t){const e=fu(t,this.type,this.Za,this.tc);return new Va(t.firestore,t.converter,function(t,e){return new Qt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function lu(...t){return new hu("endBefore",t,!0)}function du(...t){return new hu("endAt",t,!1)}function fu(t,e,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof Kc)return function(t,e,n,r,s){if(!r)throw new S(b.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of ee(t))if(o.field.isKeyField())i.push(yt(e,r.key));else{const t=r.data.field(o.field);if(rt(t))throw new S(b.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=o.field.canonicalString();throw new S(b.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Bt(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=Ec(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new S(b.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let c=0;c<s.length;c++){const i=s[c];if(o[c].field.isKeyField()){if("string"!=typeof i)throw new S(b.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!te(t)&&-1!==i.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=t.path.child(Q.fromString(i));if(!ut.isDocumentKey(n))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new ut(n);a.push(yt(e,s))}else{const t=Rc(n,r,i);a.push(t)}}return new Bt(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function mu(t,e,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(b.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!te(e)&&-1!==n.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(Q.fromString(n));if(!ut.isDocumentKey(r))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return yt(t,new ut(r))}if(n instanceof Oa)return yt(t,n._key);throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${xa(n)}.`)}function gu(t,e){if(!Array.isArray(t)||0===t.length)throw new S(b.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new S(b.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function pu(t,e,n){if(!n.isEqual(e))throw new S(b.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class yu{convertValue(t,e="none"){switch(ht(t)){case 0:return null;case 1:return t.booleanValue;case 2:return et(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(nt(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw v()}}convertObject(t,e){const n={};return j(t.fields,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new gc(et(t.latitude),et(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=st(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(it(t));default:return null}}convertTimestamp(t){const e=tt(t);return new B(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=Q.fromString(t);I(Yn(n));const r=new _a(n.get(1),n.get(3)),s=new ut(n.popFirst(5));return r.isEqual(e)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function wu(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class vu extends yu{constructor(t){super(),this.firestore=t}convertBytes(t){return new fc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Oa(this.firestore,null,e)}}class Iu{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Ec(t)}set(t,e,n){this._verifyNotCommitted();const r=Tu(t,this._firestore),s=wu(r.converter,e,n),i=bc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Ae.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=Tu(t,this._firestore);let i;return i="string"==typeof(e=(0,o.m9)(e))||e instanceof lc?xc(this._dataReader,"WriteBatch.update",s._key,e,n,r):Cc(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,Ae.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Tu(t,this._firestore);return this._mutations=this._mutations.concat(new Ue(e._key,Ae.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(b.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Tu(t,e){if((t=(0,o.m9)(t)).firestore!==e)throw new S(b.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function Eu(t){t=Ra(t,Oa);const e=Ra(t.firestore,Ha);return Ta(Xa(e),t._key).then((n=>Pu(e,t,n)))}class bu extends yu{constructor(t){super(),this.firestore=t}convertBytes(t){return new fc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Oa(this.firestore,null,e)}}function Su(t){t=Ra(t,Oa);const e=Ra(t.firestore,Ha),n=Xa(e),r=new bu(e);return function(t,e){const n=new _;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=E(t);return n.persistence.runTransaction("read document","readonly",(t=>n.Wn.Rn(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(b.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=io(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await ya(t),e,n))),n.promise}(n,t._key).then((n=>new zc(e,r,t._key,n,new Gc(null!==n&&n.hasLocalMutations,!0),t.converter)))}function _u(t){t=Ra(t,Oa);const e=Ra(t.firestore,Ha);return Ta(Xa(e),t._key,{source:"server"}).then((n=>Pu(e,t,n)))}function ku(t){t=Ra(t,Va);const e=Ra(t.firestore,Ha),n=Xa(e),r=new bu(e);return Jc(t._query),Ea(n,t._query).then((n=>new Wc(e,r,t,n)))}function Au(t){t=Ra(t,Va);const e=Ra(t.firestore,Ha),n=Xa(e),r=new bu(e);return function(t,e){const n=new _;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await zs(t,e,!0),s=new So(e,r.zn),i=s.Po(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=io(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await ya(t),e,n))),n.promise}(n,t._query).then((n=>new Wc(e,r,t,n)))}function Nu(t){t=Ra(t,Va);const e=Ra(t.firestore,Ha),n=Xa(e),r=new bu(e);return Ea(n,t._query,{source:"server"}).then((n=>new Wc(e,r,t,n)))}function Du(t,e,n){t=Ra(t,Oa);const r=Ra(t.firestore,Ha),s=wu(t.converter,e,n);return Mu(r,[bc(Ec(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,Ae.none())])}function Cu(t,e,n,...r){t=Ra(t,Oa);const s=Ra(t.firestore,Ha),i=Ec(s);let a;return a="string"==typeof(e=(0,o.m9)(e))||e instanceof lc?xc(i,"updateDoc",t._key,e,n,r):Cc(i,"updateDoc",t._key,e),Mu(s,[a.toMutation(t._key,Ae.exists(!0))])}function xu(t){return Mu(Ra(t.firestore,Ha),[new Ue(t._key,Ae.none())])}function Ru(t,e){const n=Ra(t.firestore,Ha),r=Ka(t),s=wu(t.converter,e);return Mu(n,[bc(Ec(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,Ae.exists(!1))]).then((()=>r))}function Lu(t,...e){var n,r,s;t=(0,o.m9)(t);let i={includeMetadataChanges:!1},a=0;"object"!=typeof e[a]||za(e[a])||(i=e[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(za(e[a])){const t=e[a];e[a]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[a+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[a+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let u,h,l;if(t instanceof Oa)h=Ra(t.firestore,Ha),l=Ht(t._key.path),u={next:n=>{e[a]&&e[a](Pu(h,t,n))},error:e[a+1],complete:e[a+2]};else{const n=Ra(t,Va);h=Ra(n.firestore,Ha),l=n._query;const r=new bu(h);u={next:t=>{e[a]&&e[a](new Wc(h,r,n,t))},error:e[a+1],complete:e[a+2]},Jc(t._query)}return function(t,e,n,r){const s=new aa(r),i=new yo(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>lo(await Ia(t),i))),()=>{s.na(),t.asyncQueue.enqueueAndForget((async()=>fo(await Ia(t),i)))}}(Xa(h),l,c,u)}function Fu(t,e){return function(t,e){const n=new aa(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){E(t).io.add(e),e.next()}(await Ia(t),n))),()=>{n.na(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){E(t).io.delete(e)}(await Ia(t),n)))}}(Xa(t=Ra(t,Ha)),za(e)?e:{next:e})}function Mu(t,e){return function(t,e){const n=new _;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=ea(t);try{const t=await function(t,e){const n=E(t),r=B.now(),s=e.reduce(((t,e)=>t.add(e.key)),on());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>n.Wn.vn(t,s).next((s=>{i=s;const o=[];for(const t of e){const e=Re(t,i.get(t.key));null!=e&&o.push(new Pe(t.key,e,_t(e.value.mapValue),Ae.exists(!0)))}return n.An.addMutationBatch(t,r,o,e)})))).then((t=>(t.applyToLocalDocumentSet(i),{batchId:t.batchId,changes:i})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Ko[t.currentUser.toKey()];r||(r=new Qe(V)),r=r.insert(e,n),t.Ko[t.currentUser.toKey()]=r}(r,t.batchId,n),await $o(r,t.changes),await zi(r.remoteStore)}catch(t){const e=io(t,"Failed to persist write");n.reject(e)}}(await va(t),e,n))),n.promise}(Xa(t),e)}function Pu(t,e,n){const r=n.docs.get(e._key),s=new bu(t);return new zc(t,s,e._key,r,new Gc(n.hasPendingWrites,n.fromCache),e.converter)}class Ou extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Ec(t)}get(t){const e=Tu(t,this._firestore),n=new vu(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return v();const r=t[0];if(r.isFoundDocument())return new Kc(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new Kc(this._firestore,n,e._key,null,e.converter);throw v()}))}set(t,e,n){const r=Tu(t,this._firestore),s=wu(r.converter,e,n),i=bc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=Tu(t,this._firestore);let i;return i="string"==typeof(e=(0,o.m9)(e))||e instanceof lc?xc(this._dataReader,"Transaction.update",s._key,e,n,r):Cc(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=Tu(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Tu(t,this._firestore),n=new bu(this._firestore);return super.get(t).then((t=>new zc(this._firestore,n,e._key,t._document,new Gc(!1,!1),e.converter)))}}function Vu(t,e){return function(t,e){const n=new _;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return ga(t).then((t=>t.datastore))}(t);new ha(t.asyncQueue,r,e,n).run()})),n.promise}(Xa(t=Ra(t,Ha)),(n=>e(new Ou(t,n))))}function qu(){return new Sc("deleteField")}function Uu(){return new kc("serverTimestamp")}function Bu(...t){return new Ac("arrayUnion",t)}function Ku(...t){return new Nc("arrayRemove",t)}function $u(t){return new Dc("increment",t)}function ju(t){return Xa(t=Ra(t,Ha)),new Iu(t,(e=>Mu(t,e)))}!function(t,e=!0){!function(t){l=t}(r.Jn),(0,r.Xd)(new s.wA("firestore",((t,{options:n})=>{const r=t.getProvider("app").getImmediate(),s=new Ha(r,new D(t.getProvider("auth-internal")),new L(t.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:e},n),s._setSettings(n),s}),"PUBLIC")),(0,r.KN)(u,"3.4.2",t),(0,r.KN)(u,"3.4.2","esm2017")}()}}]);